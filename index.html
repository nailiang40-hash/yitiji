<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šåŠŸèƒ½æ™ºèƒ½åˆ·é¢˜ç³»ç»Ÿ</title>
    <style>
        /* ===== åŸºç¡€æ ·å¼ä¸CSSå˜é‡ ===== */
        :root {
            --bg-color: #f8fafc; /* æµ…ç°è“ï¼ˆåç™½ï¼‰èƒŒæ™¯è‰² */
            --card-bg: #ffffff;
            --text-color: #2d3748;
            --text-secondary: #718096;
            --primary-color: #4299e1;
            --primary-hover: #3182ce;
            --success-color: #48bb78;
            --error-color: #f56565;
            --warning-color: #ed8936;
            --border-color: #e2e8f0;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.1);
            --radius: 8px;
            --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            --bg-color: #1a202c;
            --card-bg: #2d3748;
            --text-color: #e2e8f0;
            --text-secondary: #a0aec0;
            --border-color: #4a5568;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            transition: var(--transition);
            line-height: 1.6;
        }

        .container { max-width: 900px; margin: 0 auto; padding: 20px; }

        /* ===== å¤´éƒ¨æ ·å¼ ===== */
        .header { text-align: center; padding: 20px 0; margin-bottom: 15px; }
        .header h1 {
            font-size: 1.8rem; /* ç¼©å°æ ‡é¢˜å­—ä½“ */
            color: var(--text-secondary); /* æ”¹ä¸ºæ¬¡è¦æ–‡æœ¬è‰²ï¼Œé™ä½å­˜åœ¨æ„Ÿ */
            margin-bottom: 15px;
            font-weight: 500; /* é™ä½å­—é‡ */
        }

        .header-controls { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .theme-btn {
            padding: 10px 20px; border: none; border-radius: var(--radius);
            background: var(--card-bg); color: var(--text-color);
            cursor: pointer; transition: var(--transition); box-shadow: var(--shadow);
        }
        .theme-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }

        /* ===== é¡µé¢åˆ‡æ¢ ===== */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ===== ä¸Šä¼ é¡µé¢æ ·å¼ ===== */
        .upload-page { display: flex; flex-direction: column; gap: 20px; }
        .upload-card {
            background: var(--card-bg); border-radius: var(--radius);
            padding: 30px; box-shadow: var(--shadow); text-align: center;
        }
        .upload-title { font-size: 1.5rem; margin-bottom: 10px; color: var(--text-color); }
        .upload-desc { color: var(--text-secondary); margin-bottom: 20px; font-size: 0.9rem; text-align: left; display: inline-block; }
        .upload-zone {
            border: 2px dashed var(--border-color); border-radius: var(--radius);
            padding: 40px; cursor: pointer; transition: var(--transition); margin-bottom: 15px;
        }
        .upload-zone:hover { border-color: var(--primary-color); background: rgba(66, 153, 225, 0.05); }
        .upload-zone.drag-over { border-color: var(--primary-color); background: rgba(66, 153, 225, 0.1); }
        .upload-icon { font-size: 3rem; margin-bottom: 15px; }
        .file-input { display: none; }

        /* ===== é¢˜åº“åˆ—è¡¨æ ·å¼ ===== */
        .quiz-list-card { background: var(--card-bg); border-radius: var(--radius); padding: 25px; box-shadow: var(--shadow); }
        .quiz-list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .quiz-list { display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto; }
        .quiz-item {
            display: flex; align-items: center; padding: 15px;
            background: var(--bg-color); border-radius: 8px; cursor: pointer;
            transition: var(--transition); border: 2px solid transparent;
        }
        .quiz-item:hover { border-color: var(--primary-color); }
        .quiz-item.selected { border-color: var(--primary-color); background: rgba(66, 153, 225, 0.1); }
        .quiz-item-radio {
            width: 20px; height: 20px; border: 2px solid var(--border-color);
            border-radius: 50%; margin-right: 15px; display: flex; align-items: center; justify-content: center;
        }
        .quiz-item.selected .quiz-item-radio { border-color: var(--primary-color); background: var(--primary-color); }
        .quiz-item.selected .quiz-item-radio::after { content: ''; width: 8px; height: 8px; background: white; border-radius: 50%; }
        .quiz-item-info { flex: 1; min-width: 0; }
        .quiz-item-name { font-weight: 600; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        .quiz-item-meta { font-size: 0.85rem; color: var(--text-secondary); }
        .quiz-item-btn.delete {
            padding: 6px 12px; border: none; border-radius: 6px; font-size: 0.85rem;
            cursor: pointer; background: var(--error-color); color: white; transition: var(--transition);
        }
        .empty-list { text-align: center; padding: 40px; color: var(--text-secondary); }

        /* ===== æŒ‰é’®æ ·å¼ ===== */
        .start-section { display: flex; justify-content: center; gap: 15px; margin-top: 25px; flex-wrap: wrap; }
        .start-btn, .wrong-btn {
            padding: 12px 30px; /* ç¼©å°æŒ‰é’®å°ºå¯¸ */
            font-size: 1rem; /* ç¼©å°å­—ä½“ */
            font-weight: 600; border: none;
            border-radius: var(--radius); color: white; cursor: pointer;
            transition: var(--transition); box-shadow: var(--shadow);
        }
        .start-btn { background: linear-gradient(135deg, var(--primary-color), #667eea); }
        .wrong-btn { background: linear-gradient(135deg, var(--error-color), #c53030); }
        .start-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .start-btn:hover:not(:disabled), .wrong-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }

        /* ===== ç­”é¢˜é¡µé¢æ ·å¼ - æ‰å¹³åŒ–è°ƒæ•´ ===== */
        .quiz-page { 
            /* å–æ¶ˆç°åº•ç™½å¡ç‰‡è®¾è®¡ï¼Œæ‰å¹³åŒ– */
            padding: 0; 
            background: var(--bg-color); /* æµ…ç°è“èƒŒæ™¯ */
            box-shadow: none;
            border-radius: 0;
        }
        .back-btn {
            padding: 8px 16px; /* ç¼©å°è¿”å›æŒ‰é’®å°ºå¯¸ */
            border: none; border-radius: 6px; /* ç¼©å°åœ†è§’ */
            background: var(--card-bg); color: var(--text-color); cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem; /* ç¼©å°å­—ä½“ */
        }
        /* é¡¶éƒ¨å¯¼èˆªæ é‡æ„ - å®Œå…¨æ‰å¹³åŒ–è®¾è®¡ */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color); /* ä»…ä¿ç•™åº•éƒ¨åˆ†éš”çº¿ */
        }
        .timer {
            font-size: 1.2rem; /* ç¼©å°è®¡æ—¶å™¨å­—ä½“ */
            font-weight: 600;
            color: var(--primary-color);
        }
        .question-type-tag {
            display: inline-block;
            padding: 4px 12px; /* ç¼©å°æ ‡ç­¾å†…è¾¹è· */
            background: var(--primary-color);
            color: white;
            border-radius: 16px; /* è°ƒæ•´åœ†è§’ */
            font-size: 0.8rem; /* ç¼©å°å­—ä½“ */
        }
        .question-info {
            margin-bottom: 20px; /* è°ƒæ•´é—´è· */
        }
        /* é¢˜å¹²æ ·å¼ä¼˜åŒ– - å­—ä½“ç¼©å°ã€æ— åº•è‰²ã€å·¦å¯¹é½ */
        .question-content {
            font-size: 1.1rem; /* ç¼©å°å­—ä½“ */
            line-height: 1.8;
            margin-bottom: 25px; /* è°ƒæ•´é—´è· */
            padding: 0;
            background: transparent;
            border-radius: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            text-align: left;
        }
        
        /* å…±ç”¨é¢˜å¹²æ ·å¼ */
        .common-stem-wrapper {
            background: rgba(66, 153, 225, 0.05); /* æ›´æµ…çš„èƒŒæ™¯è‰² */
            border-left: 3px solid var(--primary-color); /* ç¼©å°è¾¹æ¡† */
            padding: 12px; /* ç¼©å°å†…è¾¹è· */
            margin-bottom: 18px; /* è°ƒæ•´é—´è· */
            border-radius: 4px;
            font-size: 1.05rem; /* åŒæ­¥ç¼©å° */
            color: var(--text-color);
        }

        /* è¿›åº¦æ¡ - æ‰å¹³åŒ–è®¾è®¡ */
        .progress-bar { 
            height: 6px; /* ç¼©å°è¿›åº¦æ¡é«˜åº¦ */
            background: var(--border-color); 
            border-radius: 3px; /* ç¼©å°åœ†è§’ */
            margin-bottom: 20px; 
            cursor: pointer; 
            position: relative; 
        }
        .progress-fill {
            height: 100%; 
            background: var(--primary-color); /* ç®€åŒ–æ¸å˜ï¼Œçº¯æ‰å¹³åŒ– */
            border-radius: 3px; 
            transition: width 0.3s ease;
        }

        /* é€‰é¡¹æ ·å¼ä¼˜åŒ– - çª„ä¸€ç‚¹ã€å»æ‰åœ†å½¢å•é€‰æ¡†ã€å­—æ¯å·¦å¯¹é½ã€è½»å¾®è¾¹æ¡† */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 10px; /* è°ƒæ•´é—´è· */
            margin-bottom: 30px; /* è°ƒæ•´é—´è· */
            max-width: 80%; /* é€‰é¡¹å¡ç‰‡å˜çª„ */
            margin-left: auto;
            margin-right: auto;
        }
        .option-item {
            display: flex;
            align-items: flex-start;
            padding: 12px 15px; /* ç¼©å°å†…è¾¹è· */
            background: transparent; /* å–æ¶ˆæµ…ç°èƒŒæ™¯ */
            border: 1px solid var(--border-color); /* æ›´ç»†çš„è¾¹æ¡† */
            border-radius: 6px; /* ç¼©å°åœ†è§’ */
            cursor: pointer;
            transition: var(--transition);
        }
        .option-item:hover:not(.disabled) {
            border-color: var(--primary-color);
            background: rgba(66, 153, 225, 0.05);
        }
        .option-item.selected {
            border-color: var(--primary-color);
            background: rgba(66, 153, 225, 0.1);
        }
        .option-item.correct {
            border-color: var(--success-color);
            background: rgba(72, 187, 120, 0.1);
        }
        .option-item.incorrect {
            border-color: var(--error-color);
            background: rgba(245, 101, 101, 0.1);
        }
        .option-item.disabled { cursor: not-allowed; }
        /* é€‰é¡¹å­—æ¯æ ·å¼ - å»æ‰åœ†å½¢èƒŒæ™¯ï¼Œå·¦å¯¹é½ */
        .option-label {
            width: 20px; /* ç¼©å°å®½åº¦ */
            height: 20px; /* ç¼©å°é«˜åº¦ */
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-right: 12px; /* è°ƒæ•´é—´è· */
            font-weight: 600;
            flex-shrink: 0;
            color: var(--primary-color);
            font-size: 0.9rem; /* ç¼©å°å­—ä½“ */
        }
        .option-item.selected .option-label {
            color: var(--primary-color);
        }
        .option-item.correct .option-label {
            color: var(--success-color);
        }
        .option-item.incorrect .option-label {
            color: var(--error-color);
        }
        .option-text {
            flex: 1;
            line-height: 1.6;
            padding-top: 1px;
            font-size: 0.95rem; /* ç¼©å°å­—ä½“ */
        }
        /* é€‰é¡¹åˆ¤æ–­å›¾æ ‡ */
        .option-result {
            margin-left: 8px; /* è°ƒæ•´é—´è· */
            font-size: 1rem; /* ç¼©å°å›¾æ ‡ */
            display: none;
        }
        .option-item.correct .option-result,
        .option-item.incorrect .option-result {
            display: block;
        }

        /* ç®€ç­”é¢˜ä¼˜åŒ– */
        .essay-answer-container {
            display: none;
            margin-bottom: 30px; /* è°ƒæ•´é—´è· */
            max-width: 80%; /* åŒæ­¥å˜çª„ */
            margin-left: auto;
            margin-right: auto;
        }
        .answer-input {
            width: 100%;
            min-height: 70px; /* ç¼©å°è¾“å…¥æ¡†é«˜åº¦ */
            padding: 12px; /* ç¼©å°å†…è¾¹è· */
            border: 1px solid var(--border-color); /* æ›´ç»†çš„è¾¹æ¡† */
            border-radius: 6px; /* ç¼©å°åœ†è§’ */
            font-size: 0.95rem; /* ç¼©å°å­—ä½“ */
            background: var(--card-bg);
            color: var(--text-color);
            transition: var(--transition);
            resize: vertical;
        }
        .answer-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* åº•éƒ¨æ“ä½œæ ä¼˜åŒ– - æäº¤æŒ‰é’®ç¼©å°å°ºå¯¸ */
        .submit-section {
            margin-bottom: 18px; /* è°ƒæ•´é—´è· */
            text-align: center;
        }
        .submit-btn {
            padding: 12px 40px; /* ç¼©å°æŒ‰é’®å°ºå¯¸ */
            border: none;
            border-radius: 6px; /* ç¼©å°åœ†è§’ */
            font-size: 1rem; /* ç¼©å°å­—ä½“ */
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            background: var(--primary-color);
            color: white;
            width: auto;
            min-width: 180px; /* ç¼©å°æœ€å°å®½åº¦ */
            box-shadow: none; /* ç§»é™¤é˜´å½±ï¼Œçº¯æ‰å¹³åŒ– */
        }
        .submit-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-1px); /* ç¼©å°hoverä½ç§» */
            box-shadow: var(--shadow); /* ä»…hoveræ—¶æ˜¾ç¤ºè½»å¾®é˜´å½± */
        }
        /* è°ƒæ•´ä¸Šä¸‹é¢˜æŒ‰é’®å®¹å™¨ - æ›´ç´§å‡‘ */
        .action-buttons {
            display: flex;
            justify-content: center; /* å±…ä¸­æ˜¾ç¤º */
            gap: 15px; /* ç¼©å°é—´è· */
            flex-wrap: nowrap; /* å¼ºåˆ¶å•è¡Œ */
            margin-bottom: 20px; /* è°ƒæ•´é—´è· */
            max-width: 400px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
            margin-left: auto;
            margin-right: auto;
        }
        .action-btn {
            flex: none; /* å–æ¶ˆå¼¹æ€§ä¼¸ç¼© */
            width: 120px; /* å›ºå®šå®½åº¦ */
            padding: 10px 16px; /* ç¼©å°æŒ‰é’®å°ºå¯¸ */
            border: none;
            border-radius: 6px; /* ç¼©å°åœ†è§’ */
            font-size: 0.95rem; /* ç¼©å°å­—ä½“ */
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }
        .action-btn.primary {
            background: var(--primary-color);
            color: white;
        }
        .action-btn.secondary {
            background: var(--card-bg);
            color: var(--text-color);
        }
        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* è§£æ - æ‰å¹³åŒ–è®¾è®¡ */
        .analysis-container {
            background: var(--card-bg);
            border-radius: 6px; /* ç¼©å°åœ†è§’ */
            padding: 16px; /* ç¼©å°å†…è¾¹è· */
            margin-bottom: 18px; /* è°ƒæ•´é—´è· */
            display: none;
            margin-top: 18px; /* è°ƒæ•´é—´è· */
            max-width: 80%;
            margin-left: auto;
            margin-right: auto;
            box-shadow: none; /* ç§»é™¤é˜´å½± */
            border: 1px solid var(--border-color); /* æ·»åŠ ç»†è¾¹æ¡† */
        }
        .analysis-title {
            font-weight: 600;
            margin-bottom: 8px; /* è°ƒæ•´é—´è· */
            color: var(--primary-color);
            font-size: 0.95rem; /* ç¼©å°å­—ä½“ */
        }
        .analysis-content {
            line-height: 1.7;
            white-space: pre-wrap;
            font-size: 0.95rem; /* ç¼©å°å­—ä½“ */
        }

        /* é”™é¢˜æœ¬ä¸ç»“ç®— */
        .wrong-questions-page {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 25px; /* ç¼©å°å†…è¾¹è· */
            box-shadow: var(--shadow);
        }
        .wrong-question-item {
            background: var(--bg-color);
            border-radius: 6px; /* ç¼©å°åœ†è§’ */
            padding: 16px; /* ç¼©å°å†…è¾¹è· */
            border-left: 3px solid var(--error-color); /* ç¼©å°è¾¹æ¡† */
            margin-bottom: 12px; /* è°ƒæ•´é—´è· */
        }
        .wrong-question-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px; /* è°ƒæ•´é—´è· */
            font-size: 0.95rem; /* ç¼©å°å­—ä½“ */
        }
        .wrong-answer-row {
            display: flex;
            gap: 8px; /* è°ƒæ•´é—´è· */
            margin-bottom: 4px; /* è°ƒæ•´é—´è· */
            font-size: 0.95rem; /* ç¼©å°å­—ä½“ */
        }
        .stats-section {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px; /* è°ƒæ•´é—´è· */
            margin-top: 18px; /* è°ƒæ•´é—´è· */
        }
        .stat-card {
            background: var(--bg-color);
            padding: 12px; /* ç¼©å°å†…è¾¹è· */
            text-align: center;
            border-radius: 6px; /* ç¼©å°åœ†è§’ */
            border: 1px solid var(--border-color); /* æ·»åŠ ç»†è¾¹æ¡† */
        }
        .stat-value {
            font-size: 1.3rem; /* ç¼©å°å­—ä½“ */
            font-weight: bold;
            display: block;
        }
        .stat-value.correct {
            color: var(--success-color);
        }
        .stat-value.incorrect {
            color: var(--error-color);
        }
        .stat-label {
            font-size: 0.9rem; /* ç¼©å°å­—ä½“ */
        }

        /* Toast & Modal - æ‰å¹³åŒ–è°ƒæ•´ */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
        }
        .toast {
            padding: 12px 20px; /* ç¼©å°å†…è¾¹è· */
            background: rgba(0,0,0,0.8);
            color: white;
            border-radius: 6px; /* ç¼©å°åœ†è§’ */
            margin-bottom: 8px; /* è°ƒæ•´é—´è· */
            animation: slideIn 0.3s;
            font-size: 0.95rem; /* ç¼©å°å­—ä½“ */
        }
        .toast.success {
            background: var(--success-color);
        }
        .toast.error {
            background: var(--error-color);
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: 0.3s;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: var(--card-bg);
            padding: 25px; /* ç¼©å°å†…è¾¹è· */
            border-radius: 8px; /* ç¼©å°åœ†è§’ */
            width: 90%;
            max-width: 380px; /* ç¼©å°æœ€å¤§å®½åº¦ */
            text-align: center;
            box-shadow: var(--shadow-lg);
        }
        .modal-title {
            font-size: 1.1rem; /* ç¼©å°å­—ä½“ */
            margin-bottom: 12px; /* è°ƒæ•´é—´è· */
        }
        .modal-message {
            font-size: 0.95rem; /* ç¼©å°å­—ä½“ */
            margin-bottom: 15px; /* è°ƒæ•´é—´è· */
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 12px; /* è°ƒæ•´é—´è· */
            margin-top: 18px; /* è°ƒæ•´é—´è· */
        }
        .modal-btn {
            padding: 8px 20px; /* ç¼©å°æŒ‰é’®å°ºå¯¸ */
            border-radius: 5px; /* ç¼©å°åœ†è§’ */
            border: none;
            cursor: pointer;
            font-size: 0.95rem; /* ç¼©å°å­—ä½“ */
        }
        .modal-btn.confirm {
            background: var(--primary-color);
            color: white;
        }

        @media (max-width: 768px) {
            .stats-section {
                grid-template-columns: 1fr 1fr;
            }
            .action-buttons {
                max-width: 100%; /* ç§»åŠ¨ç«¯å®½åº¦è‡ªé€‚åº” */
                width: 100%;
            }
            .action-btn {
                width: 45%; /* ç§»åŠ¨ç«¯æŒ‰é’®å¹³åˆ†å®½åº¦ */
            }
            .nav-buttons {
                flex-wrap: wrap;
            }
            .timer {
                font-size: 1.1rem; /* è¿›ä¸€æ­¥ç¼©å°ç§»åŠ¨ç«¯å­—ä½“ */
            }
            .options-container, .essay-answer-container, .analysis-container {
                max-width: 100%; /* ç§»åŠ¨ç«¯æ¢å¤å…¨å±å®½åº¦ */
            }
            .submit-btn {
                min-width: 100%; /* ç§»åŠ¨ç«¯æŒ‰é’®å…¨å±å®½åº¦ */
                padding: 10px 0; /* è°ƒæ•´ç§»åŠ¨ç«¯æŒ‰é’®å†…è¾¹è· */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>å¤šåŠŸèƒ½æ™ºèƒ½åˆ·é¢˜ç³»ç»Ÿ</h1>
            <div class="header-controls">
                <button id="themeToggleBtn" class="theme-btn">åˆ‡æ¢æ·±è‰²æ¨¡å¼</button>
            </div>
        </header>

        <div id="uploadPage" class="page active">
            <div class="upload-page">
                <div class="upload-card">
                    <h2 class="upload-title">ä¸Šä¼ é¢˜åº“å¼€å§‹åˆ·é¢˜</h2>
                    <p class="upload-desc">
                        <strong>æ”¯æŒæ ¼å¼ (TXT)ï¼š</strong><br>
                        1. <strong>A/Xå‹é€‰æ‹©é¢˜</strong>ï¼šé¢˜å¹²|é€‰é¡¹A|...|é€‰é¡¹N|ç­”æ¡ˆ|è§£æ<br>
                        2. <strong>B/ç»¼åˆé¢˜</strong>ï¼šå…±ç”¨é¢˜å¹²|å°é¢˜1|é€‰é¡¹...|ç­”æ¡ˆ|å°é¢˜2...<br>
                        3. <strong>ç®€ç­”é¢˜</strong>ï¼šQ:é—®é¢˜ (æ¢è¡Œ) A:ç­”æ¡ˆ
                    </p>
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">ğŸ“</div>
                        <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œä¸Šä¼ </div>
                        <div class="upload-hint">æ”¯æŒæ‰¹é‡ä¸Šä¼ å¤šä¸ª .txt æ–‡ä»¶</div>
                        <input type="file" id="fileInput" class="file-input" accept=".txt" multiple>
                    </div>
                </div>

                <div class="quiz-list-card">
                    <div class="quiz-list-header">
                        <h3 class="quiz-list-title">å·²ä¸Šä¼ çš„é¢˜åº“</h3>
                    </div>
                    <div class="quiz-list" id="quizList">
                        <div class="empty-list">
                            <div class="empty-list-icon">ğŸ“š</div>
                            <p>è¿˜æ²¡æœ‰ä¸Šä¼ é¢˜åº“ï¼Œå¿«æ¥ä¸Šä¼ å§ï¼</p>
                        </div>
                    </div>
                    <div class="start-section">
                        <button id="startQuizBtn" class="start-btn" disabled>å¼€å§‹åˆ·é¢˜</button>
                        <button id="wrongBookBtn" class="wrong-btn">æˆ‘çš„é”™é¢˜æœ¬</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="quizPage" class="page">
            <div class="quiz-page">
                <!-- é¡¶éƒ¨å¯¼èˆªæ é‡æ„ - å®Œå…¨æ‰å¹³åŒ–è®¾è®¡ -->
                <div class="nav-buttons">
                    <button id="quitQuizBtn" class="back-btn">é€€å‡ºç­”é¢˜</button>
                    <span id="questionType" class="question-type-tag">å•é€‰é¢˜</span>
                    <div class="timer" id="timer">00:00</div>
                </div>
                
                <div class="progress-section">
                    <div class="progress-header">
                        <span id="progressText">è¿›åº¦: 1/10</span>
                        <span id="scoreText">å¾—åˆ†: 0</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progressBar" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <div id="questionContainer">
                    <div class="question-info"></div>
                    <div id="questionContent" class="question-content"></div>
                    
                    <div id="optionsContainer" class="options-container"></div>
                    
                    <div id="essayContainer" class="essay-answer-container">
                        <textarea id="essayInput" class="answer-input" placeholder="å¯ä»¥åœ¨æ­¤è¾“å…¥å…³é”®è¯ï¼ˆéå¿…å¡«ï¼‰..."></textarea>
                    </div>

                    <!-- æäº¤æŒ‰é’®å•ç‹¬åŒºåŸŸ -->
                    <div class="submit-section">
                        <button id="submitBtn" class="submit-btn primary">æäº¤ç­”æ¡ˆ</button>
                    </div>
                    
                    <!-- ä¸Šä¸‹é¢˜æŒ‰é’®å¸ƒå±€è°ƒæ•´ -->
                    <div class="action-buttons">
                        <button id="prevBtn" class="action-btn secondary">ä¸Šä¸€é¢˜</button>
                        <button id="nextBtn" class="action-btn primary">ä¸‹ä¸€é¢˜</button>
                    </div>

                    <div id="analysisContainer" class="analysis-container">
                        <div class="analysis-title">ğŸ’¡ ç­”æ¡ˆè§£æ</div>
                        <div id="analysisContent" class="analysis-content"></div>
                    </div>
                </div>
                
                <div id="resultContainer" style="display: none; text-align: center;">
                    <div class="stat-icon" style="font-size: 3.5rem; margin-bottom: 18px;">ğŸ‰</div>
                    <h2 style="margin-bottom: 18px; font-size: 1.5rem;">æœ¬æ¬¡ç»ƒä¹ å®Œæˆ</h2>
                    <div class="stats-section">
                        <div class="stat-card">
                            <div class="stat-value total" id="resultTotal">0</div>
                            <div class="stat-label">æ€»é¢˜ç›®</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value correct" id="resultCorrect">0</div>
                            <div class="stat-label">æ­£ç¡®</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value incorrect" id="resultWrong">0</div>
                            <div class="stat-label">é”™è¯¯</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="resultScore">0</div>
                            <div class="stat-label">å¾—åˆ†</div>
                        </div>
                    </div>
                    <div class="start-section">
                        <button id="restartBtn" class="start-btn">å†æ¥ä¸€æ¬¡</button>
                        <button id="homeBtn" class="wrong-btn" style="background: var(--bg-color); color: var(--text-color);">è¿”å›ä¸»é¡µ</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="wrongPage" class="page">
            <div class="wrong-questions-page">
                <div class="wrong-questions-header">
                    <h2 class="wrong-questions-title">æˆ‘çš„é”™é¢˜æœ¬</h2>
                    <button id="backFromWrongBtn" class="back-btn" style="margin-bottom: 0;">è¿”å›ä¸»é¡µ</button>
                </div>
                
                <div id="wrongList" class="wrong-questions-list"></div>
                
                <div id="emptyWrong" class="empty-wrong" style="display:none;">
                    <div class="empty-wrong-icon">âœ¨</div>
                    <p>å¤ªæ£’äº†ï¼ç›®å‰æ²¡æœ‰é”™é¢˜è®°å½•</p>
                </div>
                
                <div style="margin-top: 18px; text-align: right;">
                    <button id="clearWrongBtn" class="clear-wrong-btn">æ¸…ç©ºé”™é¢˜æœ¬</button>
                </div>
            </div>
        </div>

        <div id="confirmModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="modal-title" id="modalTitle">æç¤º</h3>
                <p class="modal-message" id="modalMessage">ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
                <div class="modal-buttons">
                    <button id="modalCancel" class="modal-btn cancel">å–æ¶ˆ</button>
                    <button id="modalConfirm" class="modal-btn confirm">ç¡®å®š</button>
                </div>
            </div>
        </div>

        <div id="toastContainer" class="toast-container"></div>
    </div>

<script>
    // ===== å¸¸é‡å®šä¹‰ =====
    const CONST = {
        ANSWER_OPTIONS: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'],
        AUTO_NEXT_DELAY: 500, // 0.5ç§’è‡ªåŠ¨è·³è½¬
        CORRECT_ICON: 'âœ…',
        INCORRECT_ICON: 'âŒ'
    };

    // ===== æ ¸å¿ƒçŠ¶æ€ç®¡ç† =====
    const state = {
        quizzes: [],           // é¢˜åº“åˆ—è¡¨
        currentQuizIndex: -1,  // å½“å‰é¢˜åº“ç´¢å¼•
        questions: [],         // å½“å‰é¢˜ç›®åˆ—è¡¨
        userAnswers: {},       // ç”¨æˆ·ä½œç­”è®°å½•
        currentQuestionIndex: 0,
        score: 0,
        correctCount: 0,
        wrongCount: 0,
        wrongQuestions: [],    // é”™é¢˜é›†
        timer: 0,
        timerInterval: null,
        theme: 'light',
        isDragging: false,     // è¿›åº¦æ¡æ‹–æ‹½çŠ¶æ€
        isAutoNexting: false,  // æ˜¯å¦æ­£åœ¨è‡ªåŠ¨è·³è½¬
        isAnswered: false      // å½“å‰é¢˜ç›®æ˜¯å¦å·²ä½œç­”
    };

    // ===== DOM å…ƒç´ è·å– =====
    const elements = {
        uploadPage: document.getElementById('uploadPage'),
        quizPage: document.getElementById('quizPage'),
        wrongPage: document.getElementById('wrongPage'),
        themeToggleBtn: document.getElementById('themeToggleBtn'),
        fileInput: document.getElementById('fileInput'),
        uploadZone: document.getElementById('uploadZone'),
        quizList: document.getElementById('quizList'),
        startQuizBtn: document.getElementById('startQuizBtn'),
        wrongBookBtn: document.getElementById('wrongBookBtn'),
        timer: document.getElementById('timer'),
        progressSection: document.querySelector('.progress-bar'),
        progressText: document.getElementById('progressText'),
        scoreText: document.getElementById('scoreText'),
        progressBar: document.getElementById('progressBar'),
        questionType: document.getElementById('questionType'),
        questionContent: document.getElementById('questionContent'),
        optionsContainer: document.getElementById('optionsContainer'),
        essayContainer: document.getElementById('essayContainer'),
        essayInput: document.getElementById('essayInput'),
        submitBtn: document.getElementById('submitBtn'),
        nextBtn: document.getElementById('nextBtn'),
        prevBtn: document.getElementById('prevBtn'),
        quitQuizBtn: document.getElementById('quitQuizBtn'),
        analysisContainer: document.getElementById('analysisContainer'),
        analysisContent: document.getElementById('analysisContent'),
        questionContainer: document.getElementById('questionContainer'),
        resultContainer: document.getElementById('resultContainer'),
        resultTotal: document.getElementById('resultTotal'),
        resultCorrect: document.getElementById('resultCorrect'),
        resultWrong: document.getElementById('resultWrong'),
        resultScore: document.getElementById('resultScore'),
        restartBtn: document.getElementById('restartBtn'),
        homeBtn: document.getElementById('homeBtn'),
        wrongList: document.getElementById('wrongList'),
        emptyWrong: document.getElementById('emptyWrong'),
        backFromWrongBtn: document.getElementById('backFromWrongBtn'),
        clearWrongBtn: document.getElementById('clearWrongBtn'),
        confirmModal: document.getElementById('confirmModal'),
        modalTitle: document.getElementById('modalTitle'),
        modalMessage: document.getElementById('modalMessage'),
        modalConfirm: document.getElementById('modalConfirm'),
        modalCancel: document.getElementById('modalCancel'),
        toastContainer: document.getElementById('toastContainer')
    };

    // ===== åˆå§‹åŒ– =====
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        initTheme();
        renderQuizList();
        setupEventListeners();
    });

    // ===== æ•°æ®å­˜å‚¨ =====
    function loadData() {
        try {
            state.quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
            state.wrongQuestions = JSON.parse(localStorage.getItem('wrongQuestions') || '[]');
            state.theme = localStorage.getItem('theme') || 'light';
        } catch (e) { console.error("åŠ è½½æ•°æ®å¤±è´¥", e); }
    }
    function saveData() {
        localStorage.setItem('quizzes', JSON.stringify(state.quizzes));
        localStorage.setItem('wrongQuestions', JSON.stringify(state.wrongQuestions));
        localStorage.setItem('theme', state.theme);
    }

    // ===== ä¸»é¢˜æ§åˆ¶ =====
    function initTheme() {
        if (state.theme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            elements.themeToggleBtn.textContent = 'åˆ‡æ¢æµ…è‰²æ¨¡å¼';
        }
    }
    elements.themeToggleBtn.addEventListener('click', () => {
        state.theme = state.theme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', state.theme);
        elements.themeToggleBtn.textContent = state.theme === 'light' ? 'åˆ‡æ¢æ·±è‰²æ¨¡å¼' : 'åˆ‡æ¢æµ…è‰²æ¨¡å¼';
        saveData();
    });

    // ===== æ–‡ä»¶å¤„ç†ä¸è§£æ (æ ¸å¿ƒè§£æå™¨å‡çº§ç‰ˆ) =====
    elements.uploadZone.addEventListener('click', () => elements.fileInput.click());
    elements.uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); elements.uploadZone.classList.add('drag-over'); });
    elements.uploadZone.addEventListener('dragleave', () => elements.uploadZone.classList.remove('drag-over'));
    elements.uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        elements.uploadZone.classList.remove('drag-over');
        handleFiles(e.dataTransfer.files);
    });
    elements.fileInput.addEventListener('change', (e) => { handleFiles(e.target.files); e.target.value = ''; });

    function handleFiles(files) {
        if (!files.length) return;
        Array.from(files).forEach(file => {
            if (!file.name.toLowerCase().endsWith('.txt')) return showToast('è¯·ä¸Šä¼  .txt æ–‡ä»¶', 'error');
            const reader = new FileReader();
            reader.onload = (e) => {
                const questions = parseQuestionsAdvanced(e.target.result);
                if (questions.length > 0) {
                    state.quizzes.push({
                        id: Date.now() + Math.random(),
                        name: file.name.replace('.txt', ''),
                        questions: questions,
                        date: new Date().toLocaleDateString()
                    });
                    saveData();
                    renderQuizList();
                    showToast(`å¯¼å…¥æˆåŠŸ: ${file.name} (${questions.length}é¢˜)`, 'success');
                } else {
                    showToast(`${file.name} è§£æå¤±è´¥æˆ–ä¸ºç©º`, 'error');
                }
            };
            reader.readAsText(file);
        });
    }

    // æ™ºèƒ½è§£æé€»è¾‘
    function parseQuestionsAdvanced(text) {
        const lines = text.replace(/\r\n/g, '\n').split('\n').filter(l => l.trim());
        const result = [];
        let essayBuffer = { q: null, a: '' };

        lines.forEach(line => {
            line = line.trim();
            if(!line) return;

            // 1. ç®€ç­”é¢˜
            if(line.match(/^Q[:ï¼š]/i)) {
                if(essayBuffer.q) result.push(createEssay(essayBuffer));
                essayBuffer = { q: line.replace(/^Q[:ï¼š]/i, '').trim(), a: '' };
                return;
            }
            if(line.match(/^A[:ï¼š]/i) && essayBuffer.q) {
                essayBuffer.a += line.replace(/^A[:ï¼š]/i, '').trim() + '\n';
                return;
            }
            if(essayBuffer.q && !line.includes('|')) {
                essayBuffer.a += line + '\n';
                return;
            }
            if(essayBuffer.q && line.includes('|')) {
                result.push(createEssay(essayBuffer));
                essayBuffer = { q: null, a: '' };
            }

            // 2. é€‰æ‹©é¢˜ (å«å…±ç”¨é¢˜å¹²é€»è¾‘)
            if(line.includes('|')) {
                const parts = line.split('|').map(p => p.trim());
                // æŸ¥æ‰¾æ‰€æœ‰ç­”æ¡ˆä½ç½® (ç‰¹å¾: é•¿åº¦<10, å…¨ä¸ºå­—æ¯æˆ–é€—å·)
                const answerIndices = [];
                parts.forEach((p, idx) => {
                    if(idx > 0 && idx < parts.length - 1) {
                        if(/^[A-H]+([,ï¼Œ][A-H]+)*$/i.test(p) && p.length < 10) {
                            answerIndices.push(idx);
                        }
                    }
                });

                if(answerIndices.length === 0) return; 

                const analysis = parts[parts.length - 1];
                let commonStem = "";

                if(answerIndices.length > 1) {
                    commonStem = parts[0]; // ç¬¬ä¸€ä¸ªéƒ¨åˆ†æ˜¯å…±ç”¨é¢˜å¹²
                    let startIdx = 1;
                    answerIndices.forEach(ansIdx => {
                        const qParts = parts.slice(startIdx, ansIdx + 1);
                        if(qParts.length > 1) {
                            result.push(createChoice(
                                qParts[0], 
                                qParts.slice(1, -1), 
                                qParts[qParts.length - 1], 
                                analysis, 
                                commonStem
                            ));
                        }
                        startIdx = ansIdx + 1;
                    });
                } else {
                    const ansIdx = answerIndices[0];
                    result.push(createChoice(
                        parts[0],
                        parts.slice(1, ansIdx),
                        parts[ansIdx],
                        analysis,
                        ""
                    ));
                }
            }
        });
        if(essayBuffer.q) result.push(createEssay(essayBuffer));
        return result;
    }

    function createChoice(content, options, answerStr, analysis, commonStem) {
        // æ¸…ç†ç­”æ¡ˆå­—ç¬¦ä¸²ï¼Œè½¬ä¸ºå¤§å†™æ•°ç»„
        const correctAnswers = answerStr.replace(/ï¼Œ/g, ',').toUpperCase().split(/[, ]+/).filter(x => x);
        const isMulti = correctAnswers.length > 1;
        return {
            type: isMulti ? 'multiple' : 'choice',
            typeText: isMulti ? 'å¤šé€‰é¢˜' : 'å•é€‰é¢˜',
            content: content,
            options: options,
            correctAnswers: correctAnswers, // Array
            answer: answerStr, // String display
            analysis: analysis,
            commonStem: commonStem
        };
    }

    function createEssay(buffer) {
        return {
            type: 'essay',
            typeText: 'ç®€ç­”é¢˜',
            content: buffer.q,
            options: [],
            answer: buffer.a.trim(),
            correctAnswers: [],
            analysis: 'è¯·æ ¸å¯¹å‚è€ƒç­”æ¡ˆ'
        };
    }

    // ===== é¢˜åº“åˆ—è¡¨æ¸²æŸ“ =====
    function renderQuizList() {
        elements.quizList.innerHTML = '';
        if (state.quizzes.length === 0) {
            elements.quizList.innerHTML = `<div class="empty-list"><div class="empty-list-icon">ğŸ“š</div><p>è¿˜æ²¡æœ‰ä¸Šä¼ é¢˜åº“ï¼Œæ”¯æŒæ‰¹é‡ä¸Šä¼ ï¼</p></div>`;
            elements.startQuizBtn.disabled = true;
            return;
        }
        state.quizzes.forEach((quiz, index) => {
            const item = document.createElement('div');
            item.className = `quiz-item ${state.currentQuizIndex === index ? 'selected' : ''}`;
            item.onclick = (e) => { if (!e.target.closest('.delete')) selectQuiz(index); };
            item.innerHTML = `
                <div class="quiz-item-radio"></div>
                <div class="quiz-item-info">
                    <div class="quiz-item-name">${quiz.name}</div>
                    <div class="quiz-item-meta">${quiz.questions.length} é¢˜ â€¢ ${quiz.date}</div>
                </div>
                <button class="quiz-item-btn delete" onclick="deleteQuiz(${index})">åˆ é™¤</button>
            `;
            elements.quizList.appendChild(item);
        });
        elements.startQuizBtn.disabled = state.currentQuizIndex === -1;
    }
    
    function selectQuiz(idx) {
        state.currentQuizIndex = idx;
        renderQuizList();
    }
    
    // åˆ é™¤é¢˜åº“
    function deleteQuiz(idx) {
        showModal('ç¡®è®¤åˆ é™¤', `ç¡®å®šè¦åˆ é™¤é¢˜åº“ "${state.quizzes[idx].name}" å—ï¼Ÿ`, () => {
            state.quizzes.splice(idx, 1);
            if (state.currentQuizIndex === idx) {
                state.currentQuizIndex = -1;
            }
            saveData();
            renderQuizList();
            showToast('é¢˜åº“å·²åˆ é™¤', 'success');
        });
    }
    
    // ===== ç­”é¢˜é€»è¾‘ =====
    elements.startQuizBtn.addEventListener('click', startQuiz);
    elements.quitQuizBtn.addEventListener('click', () => {
        showModal('é€€å‡ºç­”é¢˜', 'ç¡®å®šè¦é€€å‡ºå½“å‰ç­”é¢˜å—ï¼Ÿè¿›åº¦å°†ä¸ä¼šä¿å­˜', () => {
            stopTimer();
            resetQuizState();
            elements.uploadPage.classList.add('active');
            elements.quizPage.classList.remove('active');
        });
    });
    
    function startQuiz() {
        if (state.currentQuizIndex === -1) return;
        
        // é‡ç½®ç­”é¢˜çŠ¶æ€
        state.questions = [...state.quizzes[state.currentQuizIndex].questions];
        state.userAnswers = {};
        state.currentQuestionIndex = 0;
        state.score = 0;
        state.correctCount = 0;
        state.wrongCount = 0;
        state.isAnswered = false;
        
        // åˆ‡æ¢é¡µé¢
        elements.uploadPage.classList.remove('active');
        elements.quizPage.classList.add('active');
        
        // å¯åŠ¨è®¡æ—¶å™¨
        startTimer();
        
        // åŠ è½½ç¬¬ä¸€é¢˜
        renderQuestion();
        updateProgress();
    }
    
    // è®¡æ—¶å™¨
    function startTimer() {
        state.timer = 0;
        stopTimer();
        state.timerInterval = setInterval(() => {
            state.timer++;
            const minutes = Math.floor(state.timer / 60).toString().padStart(2, '0');
            const seconds = (state.timer % 60).toString().padStart(2, '0');
            elements.timer.textContent = `${minutes}:${seconds}`;
        }, 1000);
    }
    
    function stopTimer() {
        if (state.timerInterval) {
            clearInterval(state.timerInterval);
            state.timerInterval = null;
        }
    }
    
    function resetQuizState() {
        stopTimer();
        elements.timer.textContent = '00:00';
        elements.resultContainer.style.display = 'none';
        elements.questionContainer.style.display = 'block';
    }
    
    // æ¸²æŸ“é¢˜ç›®
    function renderQuestion() {
        if (state.currentQuestionIndex >= state.questions.length) {
            showResult();
            return;
        }
        
        const question = state.questions[state.currentQuestionIndex];
        state.isAnswered = !!state.userAnswers[state.currentQuestionIndex];
        
        // æ›´æ–°é¢˜å‹æ ‡ç­¾
        elements.questionType.textContent = question.typeText;
        
        // æ¸²æŸ“é¢˜å¹² (åŒ…å«å…±ç”¨é¢˜å¹²)
        let questionHtml = '';
        if (question.commonStem) {
            questionHtml += `<div class="common-stem-wrapper">${question.commonStem}</div>`;
        }
        questionHtml += question.content;
        elements.questionContent.innerHTML = questionHtml;
        
        // æ¸…ç©ºé€‰é¡¹å®¹å™¨
        elements.optionsContainer.innerHTML = '';
        elements.essayContainer.style.display = 'none';
        elements.analysisContainer.style.display = 'none';
        
        // æ¸²æŸ“é€‰é¡¹
        if (question.type === 'choice' || question.type === 'multiple') {
            renderOptions(question);
        } else if (question.type === 'essay') {
            elements.essayContainer.style.display = 'block';
            elements.essayInput.value = state.userAnswers[state.currentQuestionIndex] || '';
        }
        
        // å¦‚æœå·²ä½œç­”ï¼Œè‡ªåŠ¨æ˜¾ç¤ºè§£æ
        if (state.isAnswered) {
            elements.analysisContainer.style.display = 'block';
            elements.analysisContent.textContent = question.analysis || 'æš‚æ— è§£æ';
        }
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        updateNavigationButtons();
        elements.submitBtn.disabled = state.isAnswered;
    }
    
    // æ¸²æŸ“é€‰é¡¹
    function renderOptions(question) {
        const userAnswer = state.userAnswers[state.currentQuestionIndex] || [];
        const isAnswered = state.isAnswered;
        
        question.options.forEach((option, idx) => {
            const label = CONST.ANSWER_OPTIONS[idx];
            const isSelected = userAnswer.includes(label);
            const isCorrect = question.correctAnswers.includes(label);
            const isIncorrect = isAnswered && isSelected && !isCorrect;
            
            const optionItem = document.createElement('div');
            optionItem.className = `option-item ${isSelected ? 'selected' : ''} ${isAnswered ? (isCorrect ? 'correct' : (isSelected ? 'incorrect' : '')) : ''} ${isAnswered ? 'disabled' : ''}`;
            optionItem.innerHTML = `
                <div class="option-label">${label}</div>
                <div class="option-text">${option}</div>
                <div class="option-result">${isCorrect ? CONST.CORRECT_ICON : (isIncorrect ? CONST.INCORRECT_ICON : '')}</div>
            `;
            
            if (!isAnswered) {
                optionItem.addEventListener('click', () => {
                    if (question.type === 'choice') {
                        // å•é€‰
                        elements.optionsContainer.querySelectorAll('.option-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        optionItem.classList.add('selected');
                    } else {
                        // å¤šé€‰
                        optionItem.classList.toggle('selected');
                    }
                });
            }
            
            elements.optionsContainer.appendChild(optionItem);
        });
    }
    
    // æ›´æ–°è¿›åº¦
    function updateProgress() {
        const progress = ((state.currentQuestionIndex + 1) / state.questions.length) * 100;
        elements.progressBar.style.width = `${progress}%`;
        elements.progressText.textContent = `è¿›åº¦: ${state.currentQuestionIndex + 1}/${state.questions.length}`;
        elements.scoreText.textContent = `å¾—åˆ†: ${state.score}`;
    }
    
    // æ›´æ–°å¯¼èˆªæŒ‰é’®
    function updateNavigationButtons() {
        elements.prevBtn.disabled = state.currentQuestionIndex === 0;
        elements.nextBtn.disabled = state.isAnswered && state.currentQuestionIndex === state.questions.length - 1;
        
        if (!state.isAnswered) {
            elements.nextBtn.disabled = true;
        } else if (state.isAnswered && state.currentQuestionIndex < state.questions.length - 1) {
            elements.nextBtn.disabled = false;
        }
    }
    
    // æäº¤ç­”æ¡ˆ
    elements.submitBtn.addEventListener('click', submitAnswer);
    
    function submitAnswer() {
        const question = state.questions[state.currentQuestionIndex];
        let userAnswer = [];
        
        if (question.type === 'choice' || question.type === 'multiple') {
            // è·å–é€‰ä¸­çš„é€‰é¡¹
            elements.optionsContainer.querySelectorAll('.option-item.selected').forEach(item => {
                userAnswer.push(item.querySelector('.option-label').textContent);
            });
            
            if (userAnswer.length === 0) {
                showToast('è¯·é€‰æ‹©ç­”æ¡ˆ', 'error');
                return;
            }
        } else if (question.type === 'essay') {
            userAnswer = elements.essayInput.value.trim();
            if (!userAnswer) {
                showToast('è¯·è¾“å…¥ç­”æ¡ˆ', 'error');
                return;
            }
        }
        
        // ä¿å­˜ç­”æ¡ˆ
        state.userAnswers[state.currentQuestionIndex] = userAnswer;
        state.isAnswered = true;
        
        // æ£€æŸ¥ç­”æ¡ˆ
        checkAnswer(question, userAnswer);
        
        // æ›´æ–°UI
        elements.submitBtn.disabled = true;
        renderQuestion(); // è¿™é‡Œä¼šè‡ªåŠ¨æ˜¾ç¤ºè§£æ
        updateNavigationButtons();
        updateProgress();
        
        // è‡ªåŠ¨è·³è½¬åˆ°ä¸‹ä¸€é¢˜
        if (state.currentQuestionIndex < state.questions.length - 1) {
            state.isAutoNexting = true;
            setTimeout(() => {
                if (state.isAutoNexting) {
                    nextQuestion();
                }
            }, CONST.AUTO_NEXT_DELAY);
        }
    }
    
    // æ£€æŸ¥ç­”æ¡ˆ
    function checkAnswer(question, userAnswer) {
        let isCorrect = false;
        
        if (question.type === 'choice' || question.type === 'multiple') {
            // æ’åºåæ¯”è¾ƒ
            const sortedUserAnswer = [...userAnswer].sort().join(',');
            const sortedCorrectAnswer = [...question.correctAnswers].sort().join(',');
            isCorrect = sortedUserAnswer === sortedCorrectAnswer;
        } else if (question.type === 'essay') {
            // ç®€ç­”é¢˜ç®€å•åŒ¹é…ï¼ˆå®é™…åº”ç”¨ä¸­å¯ä¼˜åŒ–ï¼‰
            isCorrect = userAnswer.toLowerCase().includes(question.answer.toLowerCase().substring(0, 10));
        }
        
        // æ›´æ–°åˆ†æ•°å’Œè®¡æ•°
        if (isCorrect) {
            state.correctCount++;
            state.score += 100 / state.questions.length;
            showToast('å›ç­”æ­£ç¡®ï¼', 'success');
        } else {
            state.wrongCount++;
            showToast('å›ç­”é”™è¯¯', 'error');
            
            // è®°å½•é”™é¢˜
            state.wrongQuestions.push({
                question: question,
                userAnswer: userAnswer,
                time: new Date().toLocaleString()
            });
            saveData();
        }
    }
    
    // ä¸Šä¸€é¢˜/ä¸‹ä¸€é¢˜
    elements.prevBtn.addEventListener('click', prevQuestion);
    elements.nextBtn.addEventListener('click', nextQuestion);
    
    function prevQuestion() {
        state.isAutoNexting = false;
        if (state.currentQuestionIndex > 0) {
            state.currentQuestionIndex--;
            renderQuestion();
            updateProgress();
        }
    }
    
    function nextQuestion() {
        state.isAutoNexting = false;
        if (state.currentQuestionIndex < state.questions.length - 1) {
            state.currentQuestionIndex++;
            renderQuestion();
            updateProgress();
        }
    }
    
    // æ˜¾ç¤ºç»“æœ
    function showResult() {
        stopTimer();
        elements.questionContainer.style.display = 'none';
        elements.resultContainer.style.display = 'block';
        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        elements.resultTotal.textContent = state.questions.length;
        elements.resultCorrect.textContent = state.correctCount;
        elements.resultWrong.textContent = state.wrongCount;
        elements.resultScore.textContent = Math.round(state.score);
    }
    
    // é‡æ–°å¼€å§‹/è¿”å›ä¸»é¡µ
    elements.restartBtn.addEventListener('click', startQuiz);
    elements.homeBtn.addEventListener('click', () => {
        resetQuizState();
        elements.uploadPage.classList.add('active');
        elements.quizPage.classList.remove('active');
    });
    
    // ===== é”™é¢˜æœ¬ =====
    elements.wrongBookBtn.addEventListener('click', showWrongQuestions);
    elements.backFromWrongBtn.addEventListener('click', () => {
        elements.wrongPage.classList.remove('active');
        elements.uploadPage.classList.add('active');
    });
    elements.clearWrongBtn.addEventListener('click', () => {
        showModal('æ¸…ç©ºé”™é¢˜æœ¬', 'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é”™é¢˜è®°å½•å—ï¼Ÿ', () => {
            state.wrongQuestions = [];
            saveData();
            renderWrongQuestions();
            showToast('é”™é¢˜æœ¬å·²æ¸…ç©º', 'success');
        });
    });
    
    function showWrongQuestions() {
        elements.uploadPage.classList.remove('active');
        elements.wrongPage.classList.add('active');
        renderWrongQuestions();
    }
    
    function renderWrongQuestions() {
        if (state.wrongQuestions.length === 0) {
            elements.emptyWrong.style.display = 'block';
            elements.wrongList.innerHTML = '';
            return;
        }
        
        elements.emptyWrong.style.display = 'none';
        elements.wrongList.innerHTML = '';
        
        state.wrongQuestions.forEach((item, idx) => {
            const wrongItem = document.createElement('div');
            wrongItem.className = 'wrong-question-item';
            
            let questionHtml = `<div class="wrong-question-header">
                <span>é”™é¢˜ ${idx + 1}</span>
                <span>${item.time}</span>
            </div>`;
            
            // é¢˜å¹²
            questionHtml += `<div class="question-content" style="font-size: 0.95rem; margin-bottom: 8px;">${item.question.content}</div>`;
            
            // ç”¨æˆ·ç­”æ¡ˆ
            questionHtml += `<div class="wrong-answer-row">
                <strong>ä½ çš„ç­”æ¡ˆï¼š</strong>
                <span>${Array.isArray(item.userAnswer) ? item.userAnswer.join(',') : item.userAnswer}</span>
            </div>`;
            
            // æ­£ç¡®ç­”æ¡ˆ
            questionHtml += `<div class="wrong-answer-row">
                <strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong>
                <span>${Array.isArray(item.question.correctAnswers) ? item.question.correctAnswers.join(',') : item.question.answer}</span>
            </div>`;
            
            // è§£æ
            questionHtml += `<div style="margin-top: 8px;">
                <strong>è§£æï¼š</strong>
                <div style="margin-top: 4px; white-space: pre-wrap; font-size: 0.95rem;">${item.question.analysis || 'æš‚æ— è§£æ'}</div>
            </div>`;
            
            wrongItem.innerHTML = questionHtml;
            elements.wrongList.appendChild(wrongItem);
        });
    }
    
    // ===== å¼¹çª—ä¸æç¤º =====
    function showModal(title, message, confirmCallback) {
        elements.modalTitle.textContent = title;
        elements.modalMessage.textContent = message;
        elements.confirmModal.classList.add('active');
        
        // ç»‘å®šç¡®è®¤äº‹ä»¶
        const confirmHandler = () => {
            confirmCallback();
            elements.confirmModal.classList.remove('active');
            elements.modalConfirm.removeEventListener('click', confirmHandler);
            elements.modalCancel.removeEventListener('click', cancelHandler);
        };
        
        const cancelHandler = () => {
            elements.confirmModal.classList.remove('active');
            elements.modalConfirm.removeEventListener('click', confirmHandler);
            elements.modalCancel.removeEventListener('click', cancelHandler);
        };
        
        elements.modalConfirm.addEventListener('click', confirmHandler);
        elements.modalCancel.addEventListener('click', cancelHandler);
    }
    
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        elements.toastContainer.appendChild(toast);
        
        // 3ç§’åç§»é™¤
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                elements.toastContainer.removeChild(toast);
            }, 300);
        }, 3000);
    }
    
    // ===== äº‹ä»¶ç›‘å¬ =====
    function setupEventListeners() {
        // è¿›åº¦æ¡ç‚¹å‡»è·³è½¬
        elements.progressSection.addEventListener('click', (e) => {
            if (state.questions.length === 0) return;
            
            const rect = elements.progressSection.getBoundingClientRect();
            const clickPos = (e.clientX - rect.left) / rect.width;
            const targetIndex = Math.floor(clickPos * state.questions.length);
            
            if (targetIndex >= 0 && targetIndex < state.questions.length) {
                state.isAutoNexting = false;
                state.currentQuestionIndex = targetIndex;
                renderQuestion();
                updateProgress();
            }
        });
    }
</script>
</body>
</html>
