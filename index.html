<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šåŠŸèƒ½æ™ºèƒ½åˆ·é¢˜ç³»ç»Ÿ v1.5</title>
    <style>
        /* ===== åŸºç¡€æ ·å¼ä¸CSSå˜é‡ ===== */
        :root {
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
            --text-color: #2d3748;
            --text-secondary: #718096;
            --primary-color: #4299e1;
            --primary-hover: #3182ce;
            --success-color: #48bb78;
            --error-color: #f56565;
            --warning-color: #ed8936;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
            --radius: 12px;
            --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            --bg-color: #1a202c;
            --card-bg: #2d3748;
            --text-color: #e2e8f0;
            --text-secondary: #a0aec0;
            --border-color: #4a5568;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            transition: var(--transition);
            line-height: 1.6;
        }

        .container { max-width: 900px; margin: 0 auto; padding: 20px; }

        /* ===== å¤´éƒ¨æ ·å¼ ===== */
        .header { text-align: center; padding: 30px 0; margin-bottom: 20px; }
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary-color), #667eea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
        }

        .header-controls { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .theme-btn {
            padding: 10px 20px; border: none; border-radius: var(--radius);
            background: var(--card-bg); color: var(--text-color);
            cursor: pointer; transition: var(--transition); box-shadow: var(--shadow);
        }
        .theme-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }

        /* ===== é¡µé¢åˆ‡æ¢ ===== */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ===== ä¸Šä¼ é¡µé¢æ ·å¼ ===== */
        .upload-page { display: flex; flex-direction: column; gap: 20px; }
        .upload-card {
            background: var(--card-bg); border-radius: var(--radius);
            padding: 30px; box-shadow: var(--shadow); text-align: center;
        }
        .upload-title { font-size: 1.5rem; margin-bottom: 10px; color: var(--text-color); }
        .upload-desc { color: var(--text-secondary); margin-bottom: 20px; font-size: 0.9rem; text-align: left; display: inline-block; }
        .upload-zone {
            border: 2px dashed var(--border-color); border-radius: var(--radius);
            padding: 40px; cursor: pointer; transition: var(--transition); margin-bottom: 15px;
        }
        .upload-zone:hover { border-color: var(--primary-color); background: rgba(66, 153, 225, 0.05); }
        .upload-zone.drag-over { border-color: var(--primary-color); background: rgba(66, 153, 225, 0.1); }
        .upload-icon { font-size: 3rem; margin-bottom: 15px; }
        .file-input { display: none; }

        /* ===== é¢˜åº“åˆ—è¡¨æ ·å¼ ===== */
        .quiz-list-card { background: var(--card-bg); border-radius: var(--radius); padding: 25px; box-shadow: var(--shadow); }
        .quiz-list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .quiz-list { display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto; }
        .quiz-item {
            display: flex; align-items: center; padding: 15px;
            background: var(--bg-color); border-radius: 8px; cursor: pointer;
            transition: var(--transition); border: 2px solid transparent;
        }
        .quiz-item:hover { border-color: var(--primary-color); }
        .quiz-item.selected { border-color: var(--primary-color); background: rgba(66, 153, 225, 0.1); }
        .quiz-item-radio {
            width: 20px; height: 20px; border: 2px solid var(--border-color);
            border-radius: 50%; margin-right: 15px; display: flex; align-items: center; justify-content: center;
        }
        .quiz-item.selected .quiz-item-radio { border-color: var(--primary-color); background: var(--primary-color); }
        .quiz-item.selected .quiz-item-radio::after { content: ''; width: 8px; height: 8px; background: white; border-radius: 50%; }
        .quiz-item-info { flex: 1; min-width: 0; }
        .quiz-item-name { font-weight: 600; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        .quiz-item-meta { font-size: 0.85rem; color: var(--text-secondary); }
        .quiz-item-btn.delete {
            padding: 6px 12px; border: none; border-radius: 6px; font-size: 0.85rem;
            cursor: pointer; background: var(--error-color); color: white; transition: var(--transition);
        }
        .empty-list { text-align: center; padding: 40px; color: var(--text-secondary); }

        /* ===== æŒ‰é’®æ ·å¼ ===== */
        .start-section { display: flex; justify-content: center; gap: 15px; margin-top: 25px; flex-wrap: wrap; }
        .start-btn, .wrong-btn {
            padding: 15px 40px; font-size: 1.1rem; font-weight: 600; border: none;
            border-radius: var(--radius); color: white; cursor: pointer;
            transition: var(--transition); box-shadow: var(--shadow);
        }
        .start-btn { background: linear-gradient(135deg, var(--primary-color), #667eea); }
        .wrong-btn { background: linear-gradient(135deg, var(--error-color), #c53030); }
        .start-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .start-btn:hover:not(:disabled), .wrong-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }

        /* ===== ç­”é¢˜é¡µé¢æ ·å¼ ===== */
        .quiz-page { background: var(--card-bg); border-radius: var(--radius); padding: 30px; box-shadow: var(--shadow); }
        .back-btn {
            padding: 10px 20px; border: none; border-radius: 8px;
            background: var(--bg-color); color: var(--text-color); cursor: pointer;
            transition: var(--transition); margin-bottom: 20px;
        }
        .timer { text-align: center; font-size: 1.5rem; font-weight: 600; color: var(--primary-color); margin-bottom: 20px; }
        .question-info { text-align: center; margin-bottom: 15px; font-size: 1.1rem; }
        .question-type-tag {
            display: inline-block; padding: 5px 15px; background: var(--primary-color);
            color: white; border-radius: 20px; font-size: 0.85rem; margin-bottom: 20px;
        }
        .question-content {
            font-size: 1.0rem; line-height: 1.8; margin-bottom: 25px; padding: 20px;
            background: var(--bg-color); border-radius: 8px; white-space: pre-wrap; word-wrap: break-word;
        }
        
        /* å…±ç”¨é¢˜å¹²æ ·å¼ */
        .common-stem-wrapper {
            background: rgba(66, 153, 225, 0.1); border-left: 4px solid var(--primary-color);
            padding: 15px; margin-bottom: 20px; border-radius: 4px;
            font-size: 1.0rem; color: var(--text-color);
        }

        /* è¿›åº¦æ¡ */
        .progress-bar { height: 8px; background: var(--bg-color); border-radius: 4px; margin-bottom: 25px; cursor: pointer; position: relative; }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, var(--primary-color), #667eea);
            border-radius: 4px; transition: width 0.3s ease;
        }

        /* é€‰é¡¹ */
        .options-container { display: flex; flex-direction: column; gap: 12px; margin-bottom: 25px; }
        .option-item {
            display: flex; align-items: flex-start; padding: 15px 20px;
            background: var(--bg-color); border: 2px solid transparent; border-radius: 8px;
            cursor: pointer; transition: var(--transition);
        }
        .option-item:hover:not(.disabled) { border-color: var(--primary-color); }
        .option-item.selected { border-color: var(--primary-color); background: rgba(66, 153, 225, 0.1); }
        .option-item.correct { border-color: var(--success-color); background: rgba(72, 187, 120, 0.1); }
        .option-item.incorrect { border-color: var(--error-color); background: rgba(245, 101, 101, 0.1); }
        .option-item.disabled { cursor: not-allowed; }
        .option-label {
            width: 30px; height: 30px; border: 2px solid var(--border-color); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; margin-right: 15px;
            font-weight: 600; flex-shrink: 0;
        }
        .option-item.selected .option-label { background: var(--primary-color); border-color: var(--primary-color); color: white; }
        .option-item.correct .option-label { background: var(--success-color); border-color: var(--success-color); color: white; }
        .option-item.incorrect .option-label { background: var(--error-color); border-color: var(--error-color); color: white; }
        .option-text { flex: 1; line-height: 1.6; padding-top: 3px; }
        /* é€‰é¡¹åˆ¤æ–­å›¾æ ‡ */
        .option-result {
            margin-left: 10px;
            font-size: 1.2rem;
            display: none;
        }
        .option-item.correct .option-result,
        .option-item.incorrect .option-result {
            display: block;
        }

        /* ç®€ç­”é¢˜ä¼˜åŒ– */
        .essay-answer-container { display: none; margin-bottom: 25px; }
        .answer-input {
            width: 100%; min-height: 80px; /* å‡å°é«˜åº¦ */
            padding: 15px; border: 2px solid var(--border-color); border-radius: 8px;
            font-size: 1rem; background: var(--bg-color); color: var(--text-color);
            transition: var(--transition); resize: vertical;
        }
        .answer-input:focus { outline: none; border-color: var(--primary-color); }

        /* åº•éƒ¨æŒ‰é’® */
        .action-buttons { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 25px; }
        .action-btn {
            flex: 1; padding: 12px 20px; border: none; border-radius: 8px;
            font-size: 1rem; font-weight: 500; cursor: pointer; transition: var(--transition);
        }
        .action-btn.primary { background: var(--primary-color); color: white; }
        .action-btn.secondary { background: var(--bg-color); color: var(--text-color); }
        .action-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* è§£æ */
        .analysis-container {
            background: var(--bg-color); border-radius: 8px; padding: 20px;
            margin-bottom: 20px; display: none;
        }
        .analysis-title { font-weight: 600; margin-bottom: 10px; color: var(--primary-color); }
        .analysis-content { line-height: 1.8; white-space: pre-wrap; }

        /* é”™é¢˜æœ¬ä¸ç»“ç®— */
        .wrong-questions-page { background: var(--card-bg); border-radius: var(--radius); padding: 30px; }
        .wrong-question-item { background: var(--bg-color); border-radius: 8px; padding: 20px; border-left: 4px solid var(--error-color); margin-bottom: 15px; }
        .wrong-question-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .wrong-answer-row { display: flex; gap: 10px; margin-bottom: 5px; }
        .stats-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 20px; }
        .stat-card { background: var(--bg-color); padding: 15px; text-align: center; border-radius: 8px; }
        .stat-value { font-size: 1.5rem; font-weight: bold; display: block; }
        .stat-value.correct { color: var(--success-color); }
        .stat-value.incorrect { color: var(--error-color); }

        /* Toast & Modal */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1001; }
        .toast { padding: 15px 25px; background: rgba(0,0,0,0.8); color: white; border-radius: 8px; margin-bottom: 10px; animation: slideIn 0.3s; }
        .toast.success { background: var(--success-color); }
        .toast.error { background: var(--error-color); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: flex; align-items: center;
            justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; }
        .modal-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .modal-btn { padding: 10px 25px; border-radius: 6px; border: none; cursor: pointer; }
        .modal-btn.confirm { background: var(--primary-color); color: white; }

        @media (max-width: 768px) {
            .stats-section { grid-template-columns: 1fr 1fr; }
            .action-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>å¤šåŠŸèƒ½æ™ºèƒ½åˆ·é¢˜ç³»ç»Ÿ</h1>
            <div class="header-controls">
                <button id="themeToggleBtn" class="theme-btn">åˆ‡æ¢æ·±è‰²æ¨¡å¼</button>
            </div>
        </header>

        <div id="uploadPage" class="page active">
            <div class="upload-page">
                <div class="upload-card">
                    <h2 class="upload-title">ä¸Šä¼ é¢˜åº“å¼€å§‹åˆ·é¢˜</h2>
                    <p class="upload-desc">
                        <strong>æ”¯æŒæ ¼å¼ (TXT)ï¼š</strong><br>
                        1. <strong>A/Xå‹é€‰æ‹©é¢˜</strong>ï¼šé¢˜å¹²|é€‰é¡¹A|...|é€‰é¡¹N|ç­”æ¡ˆ|è§£æ<br>
                        2. <strong>B/ç»¼åˆé¢˜</strong>ï¼šå…±ç”¨é¢˜å¹²|å°é¢˜1|é€‰é¡¹...|ç­”æ¡ˆ|å°é¢˜2...<br>
                        3. <strong>ç®€ç­”é¢˜</strong>ï¼šQ:é—®é¢˜ (æ¢è¡Œ) A:ç­”æ¡ˆ
                    </p>
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">ğŸ“</div>
                        <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œä¸Šä¼ </div>
                        <div class="upload-hint">æ”¯æŒæ‰¹é‡ä¸Šä¼ å¤šä¸ª .txt æ–‡ä»¶</div>
                        <input type="file" id="fileInput" class="file-input" accept=".txt" multiple>
                    </div>
                </div>

                <div class="quiz-list-card">
                    <div class="quiz-list-header">
                        <h3 class="quiz-list-title">å·²ä¸Šä¼ çš„é¢˜åº“</h3>
                    </div>
                    <div class="quiz-list" id="quizList">
                        <div class="empty-list">
                            <div class="empty-list-icon">ğŸ“š</div>
                            <p>è¿˜æ²¡æœ‰ä¸Šä¼ é¢˜åº“ï¼Œå¿«æ¥ä¸Šä¼ å§ï¼</p>
                        </div>
                    </div>
                    <div class="start-section">
                        <button id="startQuizBtn" class="start-btn" disabled>å¼€å§‹åˆ·é¢˜</button>
                        <button id="wrongBookBtn" class="wrong-btn">æˆ‘çš„é”™é¢˜æœ¬</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="quizPage" class="page">
            <div class="quiz-page">
                <div class="nav-buttons">
                    <button id="quitQuizBtn" class="back-btn">é€€å‡ºç­”é¢˜</button>
                    <div class="timer" id="timer">00:00</div>
                </div>
                
                <div class="progress-section">
                    <div class="progress-header">
                        <span id="progressText">è¿›åº¦: 1/10</span>
                        <span id="scoreText">å¾—åˆ†: 0</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progressBar" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <div id="questionContainer">
                    <div class="question-info">
                        <span id="questionType" class="question-type-tag">å•é€‰é¢˜</span>
                    </div>
                    <div id="questionContent" class="question-content"></div>
                    
                    <div id="optionsContainer" class="options-container"></div>
                    
                    <div id="essayContainer" class="essay-answer-container">
                        <textarea id="essayInput" class="answer-input" placeholder="å¯ä»¥åœ¨æ­¤è¾“å…¥å…³é”®è¯ï¼ˆéå¿…å¡«ï¼‰..."></textarea>
                    </div>

                    <div class="action-buttons">
                        <button id="prevBtn" class="action-btn secondary">ä¸Šä¸€é¢˜</button>
                        <button id="submitBtn" class="action-btn primary">æäº¤ç­”æ¡ˆ</button>
                        <button id="nextBtn" class="action-btn secondary" disabled>ä¸‹ä¸€é¢˜</button>
                    </div>

                    <div id="analysisContainer" class="analysis-container">
                        <div class="analysis-title">ğŸ’¡ ç­”æ¡ˆè§£æ</div>
                        <div id="analysisContent" class="analysis-content"></div>
                    </div>
                </div>
                
                <div id="resultContainer" style="display: none; text-align: center;">
                    <div class="stat-icon" style="font-size: 4rem; margin-bottom: 20px;">ğŸ‰</div>
                    <h2 style="margin-bottom: 20px;">æœ¬æ¬¡ç»ƒä¹ å®Œæˆ</h2>
                    <div class="stats-section">
                        <div class="stat-card">
                            <div class="stat-value total" id="resultTotal">0</div>
                            <div class="stat-label">æ€»é¢˜ç›®</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value correct" id="resultCorrect">0</div>
                            <div class="stat-label">æ­£ç¡®</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value incorrect" id="resultWrong">0</div>
                            <div class="stat-label">é”™è¯¯</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="resultScore">0</div>
                            <div class="stat-label">å¾—åˆ†</div>
                        </div>
                    </div>
                    <div class="start-section">
                        <button id="restartBtn" class="start-btn">å†æ¥ä¸€æ¬¡</button>
                        <button id="homeBtn" class="wrong-btn" style="background: var(--bg-color); color: var(--text-color);">è¿”å›ä¸»é¡µ</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="wrongPage" class="page">
            <div class="wrong-questions-page">
                <div class="wrong-questions-header">
                    <h2 class="wrong-questions-title">æˆ‘çš„é”™é¢˜æœ¬</h2>
                    <button id="backFromWrongBtn" class="back-btn" style="margin-bottom: 0;">è¿”å›ä¸»é¡µ</button>
                </div>
                
                <div id="wrongList" class="wrong-questions-list"></div>
                
                <div id="emptyWrong" class="empty-wrong" style="display:none;">
                    <div class="empty-wrong-icon">âœ¨</div>
                    <p>å¤ªæ£’äº†ï¼ç›®å‰æ²¡æœ‰é”™é¢˜è®°å½•</p>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button id="clearWrongBtn" class="clear-wrong-btn">æ¸…ç©ºé”™é¢˜æœ¬</button>
                </div>
            </div>
        </div>

        <div id="confirmModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="modal-title" id="modalTitle">æç¤º</h3>
                <p class="modal-message" id="modalMessage">ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
                <div class="modal-buttons">
                    <button id="modalCancel" class="modal-btn cancel">å–æ¶ˆ</button>
                    <button id="modalConfirm" class="modal-btn confirm">ç¡®å®š</button>
                </div>
            </div>
        </div>

        <div id="toastContainer" class="toast-container"></div>
    </div>

<script>
    // ===== å¸¸é‡å®šä¹‰ =====
    const CONST = {
        ANSWER_OPTIONS: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'],
        AUTO_NEXT_DELAY: 1000, // è‡ªåŠ¨è·³è½¬å»¶è¿Ÿ (æ¯«ç§’)
        CORRECT_ICON: 'âœ…',
        INCORRECT_ICON: 'âŒ'
    };

    // ===== æ ¸å¿ƒçŠ¶æ€ç®¡ç† =====
    const state = {
        quizzes: [],           // é¢˜åº“åˆ—è¡¨
        currentQuizIndex: -1,  // å½“å‰é¢˜åº“ç´¢å¼•
        questions: [],         // å½“å‰é¢˜ç›®åˆ—è¡¨
        userAnswers: {},       // ç”¨æˆ·ä½œç­”è®°å½•
        currentQuestionIndex: 0,
        score: 0,
        correctCount: 0,
        wrongCount: 0,
        wrongQuestions: [],    // é”™é¢˜é›†
        timer: 0,
        timerInterval: null,
        theme: 'light',
        isDragging: false,     // è¿›åº¦æ¡æ‹–æ‹½çŠ¶æ€
        isAutoNexting: false   // æ˜¯å¦æ­£åœ¨è‡ªåŠ¨è·³è½¬
    };

    // ===== DOM å…ƒç´ è·å– =====
    const elements = {
        uploadPage: document.getElementById('uploadPage'),
        quizPage: document.getElementById('quizPage'),
        wrongPage: document.getElementById('wrongPage'),
        themeToggleBtn: document.getElementById('themeToggleBtn'),
        fileInput: document.getElementById('fileInput'),
        uploadZone: document.getElementById('uploadZone'),
        quizList: document.getElementById('quizList'),
        startQuizBtn: document.getElementById('startQuizBtn'),
        wrongBookBtn: document.getElementById('wrongBookBtn'),
        timer: document.getElementById('timer'),
        progressSection: document.querySelector('.progress-bar'),
        progressText: document.getElementById('progressText'),
        scoreText: document.getElementById('scoreText'),
        progressBar: document.getElementById('progressBar'),
        questionType: document.getElementById('questionType'),
        questionContent: document.getElementById('questionContent'),
        optionsContainer: document.getElementById('optionsContainer'),
        essayContainer: document.getElementById('essayContainer'),
        essayInput: document.getElementById('essayInput'),
        submitBtn: document.getElementById('submitBtn'),
        nextBtn: document.getElementById('nextBtn'),
        prevBtn: document.getElementById('prevBtn'), // æ–°å¢ä¸Šä¸€é¢˜æŒ‰é’®
        quitQuizBtn: document.getElementById('quitQuizBtn'),
        analysisContainer: document.getElementById('analysisContainer'),
        analysisContent: document.getElementById('analysisContent'),
        questionContainer: document.getElementById('questionContainer'),
        resultContainer: document.getElementById('resultContainer'),
        resultTotal: document.getElementById('resultTotal'),
        resultCorrect: document.getElementById('resultCorrect'),
        resultWrong: document.getElementById('resultWrong'),
        resultScore: document.getElementById('resultScore'),
        restartBtn: document.getElementById('restartBtn'),
        homeBtn: document.getElementById('homeBtn'),
        wrongList: document.getElementById('wrongList'),
        emptyWrong: document.getElementById('emptyWrong'),
        backFromWrongBtn: document.getElementById('backFromWrongBtn'),
        clearWrongBtn: document.getElementById('clearWrongBtn'),
        confirmModal: document.getElementById('confirmModal'),
        modalTitle: document.getElementById('modalTitle'),
        modalMessage: document.getElementById('modalMessage'),
        modalConfirm: document.getElementById('modalConfirm'),
        modalCancel: document.getElementById('modalCancel'),
        toastContainer: document.getElementById('toastContainer')
    };

    // ===== åˆå§‹åŒ– =====
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        initTheme();
        renderQuizList();
        setupEventListeners();
    });

    // ===== æ•°æ®å­˜å‚¨ =====
    function loadData() {
        try {
            state.quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
            state.wrongQuestions = JSON.parse(localStorage.getItem('wrongQuestions') || '[]');
            state.theme = localStorage.getItem('theme') || 'light';
        } catch (e) { console.error("åŠ è½½æ•°æ®å¤±è´¥", e); }
    }
    function saveData() {
        localStorage.setItem('quizzes', JSON.stringify(state.quizzes));
        localStorage.setItem('wrongQuestions', JSON.stringify(state.wrongQuestions));
        localStorage.setItem('theme', state.theme);
    }

    // ===== ä¸»é¢˜æ§åˆ¶ =====
    function initTheme() {
        if (state.theme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            elements.themeToggleBtn.textContent = 'åˆ‡æ¢æµ…è‰²æ¨¡å¼';
        }
    }
    elements.themeToggleBtn.addEventListener('click', () => {
        state.theme = state.theme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', state.theme);
        elements.themeToggleBtn.textContent = state.theme === 'light' ? 'åˆ‡æ¢æ·±è‰²æ¨¡å¼' : 'åˆ‡æ¢æµ…è‰²æ¨¡å¼';
        saveData();
    });

    // ===== æ–‡ä»¶å¤„ç†ä¸è§£æ (æ ¸å¿ƒè§£æå™¨å‡çº§ç‰ˆ) =====
    elements.uploadZone.addEventListener('click', () => elements.fileInput.click());
    elements.uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); elements.uploadZone.classList.add('drag-over'); });
    elements.uploadZone.addEventListener('dragleave', () => elements.uploadZone.classList.remove('drag-over'));
    elements.uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        elements.uploadZone.classList.remove('drag-over');
        handleFiles(e.dataTransfer.files);
    });
    elements.fileInput.addEventListener('change', (e) => { handleFiles(e.target.files); e.target.value = ''; });

    function handleFiles(files) {
        if (!files.length) return;
        Array.from(files).forEach(file => {
            if (!file.name.toLowerCase().endsWith('.txt')) return showToast('è¯·ä¸Šä¼  .txt æ–‡ä»¶', 'error');
            const reader = new FileReader();
            reader.onload = (e) => {
                const questions = parseQuestionsAdvanced(e.target.result);
                if (questions.length > 0) {
                    state.quizzes.push({
                        id: Date.now() + Math.random(),
                        name: file.name.replace('.txt', ''),
                        questions: questions,
                        date: new Date().toLocaleDateString()
                    });
                    saveData();
                    renderQuizList();
                    showToast(`å¯¼å…¥æˆåŠŸ: ${file.name} (${questions.length}é¢˜)`, 'success');
                } else {
                    showToast(`${file.name} è§£æå¤±è´¥æˆ–ä¸ºç©º`, 'error');
                }
            };
            reader.readAsText(file);
        });
    }

    // æ™ºèƒ½è§£æé€»è¾‘
    function parseQuestionsAdvanced(text) {
        const lines = text.replace(/\r\n/g, '\n').split('\n').filter(l => l.trim());
        const result = [];
        let essayBuffer = { q: null, a: '' };

        lines.forEach(line => {
            line = line.trim();
            if(!line) return;

            // 1. ç®€ç­”é¢˜
            if(line.match(/^Q[:ï¼š]/i)) {
                if(essayBuffer.q) result.push(createEssay(essayBuffer));
                essayBuffer = { q: line.replace(/^Q[:ï¼š]/i, '').trim(), a: '' };
                return;
            }
            if(line.match(/^A[:ï¼š]/i) && essayBuffer.q) {
                essayBuffer.a += line.replace(/^A[:ï¼š]/i, '').trim() + '\n';
                return;
            }
            if(essayBuffer.q && !line.includes('|')) {
                essayBuffer.a += line + '\n';
                return;
            }
            if(essayBuffer.q && line.includes('|')) {
                result.push(createEssay(essayBuffer));
                essayBuffer = { q: null, a: '' };
            }

            // 2. é€‰æ‹©é¢˜ (å«å…±ç”¨é¢˜å¹²é€»è¾‘)
            if(line.includes('|')) {
                const parts = line.split('|').map(p => p.trim());
                // æŸ¥æ‰¾æ‰€æœ‰ç­”æ¡ˆä½ç½® (ç‰¹å¾: é•¿åº¦<10, å…¨ä¸ºå­—æ¯æˆ–é€—å·)
                const answerIndices = [];
                parts.forEach((p, idx) => {
                    if(idx > 0 && idx < parts.length - 1) {
                        if(/^[A-H]+([,ï¼Œ][A-H]+)*$/i.test(p) && p.length < 10) {
                            answerIndices.push(idx);
                        }
                    }
                });

                if(answerIndices.length === 0) return; 

                const analysis = parts[parts.length - 1];
                let commonStem = "";

                if(answerIndices.length > 1) {
                    commonStem = parts[0]; // ç¬¬ä¸€ä¸ªéƒ¨åˆ†æ˜¯å…±ç”¨é¢˜å¹²
                    let startIdx = 1;
                    answerIndices.forEach(ansIdx => {
                        const qParts = parts.slice(startIdx, ansIdx + 1);
                        if(qParts.length > 1) {
                            result.push(createChoice(
                                qParts[0], 
                                qParts.slice(1, -1), 
                                qParts[qParts.length - 1], 
                                analysis, 
                                commonStem
                            ));
                        }
                        startIdx = ansIdx + 1;
                    });
                } else {
                    const ansIdx = answerIndices[0];
                    result.push(createChoice(
                        parts[0],
                        parts.slice(1, ansIdx),
                        parts[ansIdx],
                        analysis,
                        ""
                    ));
                }
            }
        });
        if(essayBuffer.q) result.push(createEssay(essayBuffer));
        return result;
    }

    function createChoice(content, options, answerStr, analysis, commonStem) {
        // æ¸…ç†ç­”æ¡ˆå­—ç¬¦ä¸²ï¼Œè½¬ä¸ºå¤§å†™æ•°ç»„
        const correctAnswers = answerStr.replace(/ï¼Œ/g, ',').toUpperCase().split(/[, ]+/).filter(x => x);
        const isMulti = correctAnswers.length > 1;
        return {
            type: isMulti ? 'multiple' : 'choice',
            typeText: isMulti ? 'å¤šé€‰é¢˜' : 'å•é€‰é¢˜',
            content: content,
            options: options,
            correctAnswers: correctAnswers, // Array
            answer: answerStr, // String display
            analysis: analysis,
            commonStem: commonStem
        };
    }

    function createEssay(buffer) {
        return {
            type: 'essay',
            typeText: 'ç®€ç­”é¢˜',
            content: buffer.q,
            options: [],
            answer: buffer.a.trim(),
            correctAnswers: [],
            analysis: 'è¯·æ ¸å¯¹å‚è€ƒç­”æ¡ˆ'
        };
    }

    // ===== é¢˜åº“åˆ—è¡¨æ¸²æŸ“ =====
    function renderQuizList() {
        elements.quizList.innerHTML = '';
        if (state.quizzes.length === 0) {
            elements.quizList.innerHTML = `<div class="empty-list"><div class="empty-list-icon">ğŸ“š</div><p>è¿˜æ²¡æœ‰ä¸Šä¼ é¢˜åº“ï¼Œæ”¯æŒæ‰¹é‡ä¸Šä¼ ï¼</p></div>`;
            elements.startQuizBtn.disabled = true;
            return;
        }
        state.quizzes.forEach((quiz, index) => {
            const item = document.createElement('div');
            item.className = `quiz-item ${state.currentQuizIndex === index ? 'selected' : ''}`;
            item.onclick = (e) => { if (!e.target.closest('.delete')) selectQuiz(index); };
            item.innerHTML = `
                <div class="quiz-item-radio"></div>
                <div class="quiz-item-info">
                    <div class="quiz-item-name">${quiz.name}</div>
                    <div class="quiz-item-meta">${quiz.questions.length} é¢˜ â€¢ ${quiz.date}</div>
                </div>
                <button class="quiz-item-btn delete" onclick="deleteQuiz(${index})">åˆ é™¤</button>
            `;
            elements.quizList.appendChild(item);
        });
        elements.startQuizBtn.disabled = state.currentQuizIndex === -1;
    }
    function selectQuiz(idx) { state.currentQuizIndex = idx; renderQuizList(); }
    window.deleteQuiz = function(idx) {
        showModal('ç¡®è®¤åˆ é™¤', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢˜åº“å—ï¼Ÿ', () => {
            state.quizzes.splice(idx, 1);
            if(state.currentQuizIndex === idx) state.currentQuizIndex = -1;
            saveData(); renderQuizList();
        });
    };

    // ===== ç­”é¢˜é€»è¾‘ =====
    elements.startQuizBtn.addEventListener('click', () => {
        if(state.currentQuizIndex === -1) return;
        startQuiz(state.quizzes[state.currentQuizIndex].questions);
    });

    function startQuiz(questions) {
        state.questions = JSON.parse(JSON.stringify(questions));
        state.currentQuestionIndex = 0;
        state.score = 0; state.correctCount = 0; state.wrongCount = 0; state.timer = 0;
        state.userAnswers = {};
        
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        elements.quizPage.classList.add('active');
        elements.resultContainer.style.display = 'none';
        elements.questionContainer.style.display = 'block';
        
        startTimer();
        renderQuestion();
        updateNavButtons(); // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
    }

    function renderQuestion() {
        // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„è‡ªåŠ¨è·³è½¬
        if(state.isAutoNexting) {
            clearTimeout(state.isAutoNexting);
            state.isAutoNexting = false;
        }
        
        const q = state.questions[state.currentQuestionIndex];
        const userRec = state.userAnswers[state.currentQuestionIndex] || {};
        
        // æ›´æ–°è¿›åº¦
        const total = state.questions.length;
        elements.progressText.textContent = `è¿›åº¦: ${state.currentQuestionIndex + 1}/${total}`;
        elements.scoreText.textContent = `å¾—åˆ†: ${state.score}`;
        elements.progressBar.style.width = `${((state.currentQuestionIndex + 1) / total) * 100}%`;

        // æ¸²æŸ“é¢˜å¹² (å«å…±ç”¨é¢˜å¹²)
        let html = '';
        if(q.commonStem) html += `<div class="common-stem-wrapper"><strong>èƒŒæ™¯ï¼š</strong>${q.commonStem}</div>`;
        html += q.content;
        elements.questionContent.innerHTML = html;
        elements.questionType.textContent = q.typeText;

        // UIé‡ç½®
        elements.analysisContainer.style.display = 'none';
        elements.optionsContainer.innerHTML = '';
        const hasAnswered = !!userRec.isAnswered;
        
        // æ›´æ–°æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        elements.submitBtn.style.display = hasAnswered ? 'none' : 'block';
        elements.nextBtn.style.display = 'block'; // å§‹ç»ˆæ˜¾ç¤ºä¸‹ä¸€é¢˜æŒ‰é’®
        elements.nextBtn.disabled = !hasAnswered; // æ ¹æ®æ˜¯å¦ç­”é¢˜ç¦ç”¨/å¯ç”¨
        
        // æ›´æ–°ä¸Šä¸€é¢˜æŒ‰é’®çŠ¶æ€
        updateNavButtons();

        if(hasAnswered && q.type !== 'essay') {
            elements.analysisContainer.style.display = 'block';
            elements.analysisContent.textContent = q.analysis;
        }

        if(q.type === 'essay') {
            elements.optionsContainer.style.display = 'none';
            elements.essayContainer.style.display = 'block';
            elements.essayInput.value = userRec.input || '';
            // ç®€ç­”é¢˜æŒ‰é’®é€»è¾‘ä¼˜åŒ–
            elements.submitBtn.textContent = hasAnswered ? 'å·²æŸ¥çœ‹ç­”æ¡ˆ' : 'æŸ¥çœ‹å‚è€ƒç­”æ¡ˆ';
            if(hasAnswered) {
                elements.analysisContainer.style.display = 'block';
                elements.analysisContent.textContent = `å‚è€ƒç­”æ¡ˆï¼š\n${q.answer}`;
            }
        } else {
            elements.optionsContainer.style.display = 'flex';
            elements.essayContainer.style.display = 'none';
            elements.submitBtn.textContent = 'æäº¤ç­”æ¡ˆ';
            
            q.options.forEach((opt, idx) => {
                const optionLetter = CONST.ANSWER_OPTIONS[idx];
                const optionItem = document.createElement('div');
                optionItem.className = `option-item ${userRec.selected === optionLetter ? 'selected' : ''}`;
                
                // æ·»åŠ åˆ¤æ–­çŠ¶æ€ç±»å’Œå›¾æ ‡
                if(hasAnswered) {
                    if(q.correctAnswers.includes(optionLetter)) {
                        optionItem.classList.add('correct');
                    } else if(userRec.selected === optionLetter && !q.correctAnswers.includes(optionLetter)) {
                        optionItem.classList.add('incorrect');
                    }
                    optionItem.classList.add('disabled');
                }
                
                optionItem.innerHTML = `
                    <div class="option-label">${optionLetter}</div>
                    <div class="option-text">${opt}</div>
                    <div class="option-result">
                        ${q.correctAnswers.includes(optionLetter) ? CONST.CORRECT_ICON : 
                          (userRec.selected === optionLetter && !q.correctAnswers.includes(optionLetter)) ? CONST.INCORRECT_ICON : ''}
                    </div>
                `;
                
                // å•é€‰é¢˜ç§’é€‰ç§’åˆ¤é€»è¾‘
                if(!hasAnswered && q.type === 'choice') {
                    optionItem.addEventListener('click', () => {
                        checkAnswer(optionLetter);
                    });
                }
                
                // å¤šé€‰é¢˜ä»éœ€ç‚¹å‡»æäº¤
                if(!hasAnswered && q.type === 'multiple') {
                    optionItem.addEventListener('click', () => {
                        optionItem.classList.toggle('selected');
                    });
                }
                
                elements.optionsContainer.appendChild(optionItem);
            });
        }
    }

    // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€ï¼ˆä¸Šä¸€é¢˜/ä¸‹ä¸€é¢˜ï¼‰
    function updateNavButtons() {
        const total = state.questions.length;
        // ä¸Šä¸€é¢˜æŒ‰é’®ï¼šç¬¬ä¸€é¢˜ç¦ç”¨
        elements.prevBtn.disabled = state.currentQuestionIndex === 0;
        // ä¸‹ä¸€é¢˜æŒ‰é’®ï¼šæœ€åä¸€é¢˜ä¸”å·²ç­”é¢˜åˆ™ç¦ç”¨
        elements.nextBtn.disabled = !state.userAnswers[state.currentQuestionIndex]?.isAnswered || 
                                  state.currentQuestionIndex === total - 1;
    }

    // æ£€æŸ¥ç­”æ¡ˆï¼ˆç§’é€‰ç§’åˆ¤æ ¸å¿ƒé€»è¾‘ï¼‰
    function checkAnswer(selectedOption) {
        const qIdx = state.currentQuestionIndex;
        const q = state.questions[qIdx];
        
        // æ ‡è®°å·²ç­”é¢˜
        state.userAnswers[qIdx] = {
            selected: selectedOption,
            isAnswered: true,
            input: q.type === 'essay' ? elements.essayInput.value : ''
        };
        
        const isCorrect = q.correctAnswers.includes(selectedOption);
        
        // æ›´æ–°å¾—åˆ†å’Œç»Ÿè®¡
        if(isCorrect) {
            state.score += 1;
            state.correctCount += 1;
        } else {
            state.wrongCount += 1;
            // æ·»åŠ åˆ°é”™é¢˜æœ¬
            state.wrongQuestions.push({
                ...q,
                userAnswer: selectedOption,
                time: new Date().toLocaleString()
            });
            saveData();
        }
        
        // é‡æ–°æ¸²æŸ“é¢˜ç›®æ˜¾ç¤ºåˆ¤æ–­ç»“æœ
        renderQuestion();
        
        // ç­”å¯¹ï¼š1ç§’åè‡ªåŠ¨ä¸‹ä¸€é¢˜
        if(isCorrect) {
            state.isAutoNexting = setTimeout(() => {
                nextQuestion();
            }, CONST.AUTO_NEXT_DELAY);
        } else {
            // ç­”é”™ï¼šå±•å¼€è§£æï¼Œä¸è‡ªåŠ¨è·³è½¬
            elements.analysisContainer.style.display = 'block';
            elements.analysisContent.textContent = q.analysis;
        }
        
        saveData();
    }

    // æäº¤ç­”æ¡ˆï¼ˆå¤šé€‰é¢˜/ç®€ç­”é¢˜ï¼‰
    elements.submitBtn.addEventListener('click', () => {
        const qIdx = state.currentQuestionIndex;
        const q = state.questions[qIdx];
        
        if(q.type === 'multiple') {
            // å¤šé€‰é¢˜è·å–é€‰ä¸­é€‰é¡¹
            const selectedOptions = [];
            document.querySelectorAll('.option-item.selected').forEach((item, idx) => {
                selectedOptions.push(CONST.ANSWER_OPTIONS[idx]);
            });
            
            if(selectedOptions.length === 0) {
                showToast('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªé€‰é¡¹', 'error');
                return;
            }
            
            // æ£€æŸ¥å¤šé€‰é¢˜ç­”æ¡ˆ
            const isCorrect = JSON.stringify(selectedOptions.sort()) === JSON.stringify(q.correctAnswers.sort());
            
            state.userAnswers[qIdx] = {
                selected: selectedOptions.join(','),
                isAnswered: true
            };
            
            if(isCorrect) {
                state.score += 1;
                state.correctCount += 1;
            } else {
                state.wrongCount += 1;
                state.wrongQuestions.push({
                    ...q,
                    userAnswer: selectedOptions.join(','),
                    time: new Date().toLocaleString()
                });
                saveData();
            }
            
            renderQuestion();
            elements.analysisContainer.style.display = 'block';
            elements.analysisContent.textContent = q.analysis;
            
        } else if(q.type === 'essay') {
            // ç®€ç­”é¢˜ï¼šæ— éœ€éªŒè¯ï¼Œç›´æ¥æ ‡è®°å·²ç­”é¢˜
            state.userAnswers[qIdx] = {
                input: elements.essayInput.value,
                isAnswered: true
            };
            
            renderQuestion();
        }
        
        saveData();
        updateNavButtons();
    });

    // ä¸Šä¸€é¢˜
    elements.prevBtn.addEventListener('click', () => {
        if(state.currentQuestionIndex > 0) {
            state.currentQuestionIndex -= 1;
            renderQuestion();
        }
    });

    // ä¸‹ä¸€é¢˜
    elements.nextBtn.addEventListener('click', nextQuestion);
    
    function nextQuestion() {
        if(state.currentQuestionIndex < state.questions.length - 1) {
            state.currentQuestionIndex += 1;
            renderQuestion();
        } else {
            // æœ€åä¸€é¢˜ï¼Œæ˜¾ç¤ºç»“æœ
            showResult();
        }
    }

    // æ˜¾ç¤ºç­”é¢˜ç»“æœ
    function showResult() {
        clearInterval(state.timerInterval);
        elements.questionContainer.style.display = 'none';
        elements.resultContainer.style.display = 'block';
        
        elements.resultTotal.textContent = state.questions.length;
        elements.resultCorrect.textContent = state.correctCount;
        elements.resultWrong.textContent = state.wrongCount;
        elements.resultScore.textContent = state.score;
    }

    // é€€å‡ºç­”é¢˜
    elements.quitQuizBtn.addEventListener('click', () => {
        showModal('ç¡®è®¤é€€å‡º', 'é€€å‡ºåå°†ä¸¢å¤±æœ¬æ¬¡ç­”é¢˜è¿›åº¦ï¼Œç¡®å®šå—ï¼Ÿ', () => {
            clearInterval(state.timerInterval);
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            elements.uploadPage.classList.add('active');
        });
    });

    // å†æ¥ä¸€æ¬¡
    elements.restartBtn.addEventListener('click', () => {
        startQuiz(state.questions);
    });

    // è¿”å›ä¸»é¡µ
    elements.homeBtn.addEventListener('click', () => {
        clearInterval(state.timerInterval);
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        elements.uploadPage.classList.add('active');
    });

    // é”™é¢˜æœ¬
    elements.wrongBookBtn.addEventListener('click', () => {
        renderWrongQuestions();
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        elements.wrongPage.classList.add('active');
    });

    // è¿”å›ä¸»é¡µï¼ˆä»é”™é¢˜æœ¬ï¼‰
    elements.backFromWrongBtn.addEventListener('click', () => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        elements.uploadPage.classList.add('active');
    });

    // æ¸…ç©ºé”™é¢˜æœ¬
    elements.clearWrongBtn.addEventListener('click', () => {
        showModal('æ¸…ç©ºé”™é¢˜æœ¬', 'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é”™é¢˜è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼', () => {
            state.wrongQuestions = [];
            saveData();
            renderWrongQuestions();
        });
    });

    // æ¸²æŸ“é”™é¢˜æœ¬
    function renderWrongQuestions() {
        if(state.wrongQuestions.length === 0) {
            elements.wrongList.style.display = 'none';
            elements.emptyWrong.style.display = 'block';
            return;
        }
        
        elements.emptyWrong.style.display = 'none';
        elements.wrongList.innerHTML = '';
        
        state.wrongQuestions.forEach((q, idx) => {
            const item = document.createElement('div');
            item.className = 'wrong-question-item';
            
            let content = `<div class="wrong-question-header">
                <span>${idx + 1}. ${q.typeText}</span>
                <span>${q.time}</span>
            </div>`;
            
            if(q.commonStem) {
                content += `<div class="common-stem-wrapper"><strong>èƒŒæ™¯ï¼š</strong>${q.commonStem}</div>`;
            }
            
            content += `<div class="question-content" style="margin: 10px 0;">${q.content}</div>`;
            
            if(q.options.length > 0) {
                content += `<div class="options-container" style="margin: 10px 0;">`;
                q.options.forEach((opt, i) => {
                    const letter = CONST.ANSWER_OPTIONS[i];
                    const isCorrect = q.correctAnswers.includes(letter);
                    const isUserAnswer = q.userAnswer.includes(letter);
                    
                    content += `<div class="option-item ${isCorrect ? 'correct' : isUserAnswer ? 'incorrect' : ''}">
                        <div class="option-label">${letter}</div>
                        <div class="option-text">${opt}</div>
                        <div class="option-result">
                            ${isCorrect ? CONST.CORRECT_ICON : isUserAnswer ? CONST.INCORRECT_ICON : ''}
                        </div>
                    </div>`;
                });
                content += `</div>`;
            }
            
            content += `<div class="wrong-answer-row">
                <strong>ä½ çš„ç­”æ¡ˆï¼š</strong> ${q.userAnswer || 'æœªä½œç­”'}
            </div>`;
            content += `<div class="wrong-answer-row">
                <strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong> ${q.answer || 'æ— '}
            </div>`;
            content += `<div class="analysis-container" style="display:block; margin-top:10px">
                <div class="analysis-title">ğŸ’¡ ç­”æ¡ˆè§£æ</div>
                <div class="analysis-content">${q.analysis}</div>
            </div>`;
            
            item.innerHTML = content;
            elements.wrongList.appendChild(item);
        });
    }

    // ===== è®¡æ—¶å™¨ =====
    function startTimer() {
        clearInterval(state.timerInterval);
        state.timerInterval = setInterval(() => {
            state.timer++;
            const minutes = Math.floor(state.timer / 60).toString().padStart(2, '0');
            const seconds = (state.timer % 60).toString().padStart(2, '0');
            elements.timer.textContent = `${minutes}:${seconds}`;
        }, 1000);
    }

    // ===== å¼¹çª—ä¸æç¤º =====
    function showModal(title, message, confirmCallback) {
        elements.modalTitle.textContent = title;
        elements.modalMessage.textContent = message;
        elements.confirmModal.classList.add('active');
        
        elements.modalConfirm.onclick = () => {
            elements.confirmModal.classList.remove('active');
            confirmCallback();
        };
        
        elements.modalCancel.onclick = () => {
            elements.confirmModal.classList.remove('active');
        };
    }

    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        elements.toastContainer.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // ===== äº‹ä»¶ç›‘å¬ =====
    function setupEventListeners() {
        // è¿›åº¦æ¡ç‚¹å‡»è·³è½¬
        elements.progressSection.addEventListener('click', (e) => {
            if(state.questions.length === 0) return;
            const rect = elements.progressSection.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            const newIndex = Math.min(
                state.questions.length - 1,
                Math.max(0, Math.floor(percent * state.questions.length))
            );
            state.currentQuestionIndex = newIndex;
            renderQuestion();
        });
        
        // é˜»æ­¢è¿›åº¦æ¡æ‹–æ‹½
        elements.progressSection.addEventListener('mousedown', () => {
            state.isDragging = true;
        });
        document.addEventListener('mouseup', () => {
            state.isDragging = false;
        });
        document.addEventListener('mousemove', (e) => {
            if(state.isDragging) {
                const rect = elements.progressSection.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                const newIndex = Math.min(
                    state.questions.length - 1,
                    Math.max(0, Math.floor(percent * state.questions.length))
                );
                state.currentQuestionIndex = newIndex;
                renderQuestion();
            }
        });
    }
</script>
</body>
</html>
