<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šåŠŸèƒ½æ™ºèƒ½åˆ·é¢˜ç³»ç»Ÿ</title>
    <style>
        /* ===== åŸºç¡€æ ·å¼ä¸CSSå˜é‡ ===== */
        :root {
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
            --text-color: #2d3748;
            --text-secondary: #718096;
            --primary-color: #4299e1;
            --primary-hover: #3182ce;
            --success-color: #48bb78;
            --error-color: #f56565;
            --warning-color: #ed8936;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
            --radius: 12px;
            --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            --bg-color: #1a202c;
            --card-bg: #2d3748;
            --text-color: #e2e8f0;
            --text-secondary: #a0aec0;
            --border-color: #4a5568;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            transition: var(--transition);
            line-height: 1.6;
        }

        .container { max-width: 900px; margin: 0 auto; padding: 20px; }

        /* ===== å¤´éƒ¨æ ·å¼ ===== */
        .header { text-align: center; padding: 30px 0; margin-bottom: 20px; }
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary-color), #667eea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
        }

        .header-controls { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .theme-btn {
            padding: 10px 20px; border: none; border-radius: var(--radius);
            background: var(--card-bg); color: var(--text-color);
            cursor: pointer; transition: var(--transition); box-shadow: var(--shadow);
        }
        .theme-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }

        /* ===== é¡µé¢åˆ‡æ¢ ===== */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ===== ä¸Šä¼ é¡µé¢æ ·å¼ ===== */
        .upload-page { display: flex; flex-direction: column; gap: 20px; }
        .upload-card {
            background: var(--card-bg); border-radius: var(--radius);
            padding: 30px; box-shadow: var(--shadow); text-align: center;
        }
        .upload-title { font-size: 1.5rem; margin-bottom: 10px; color: var(--text-color); }
        .upload-desc { color: var(--text-secondary); margin-bottom: 20px; font-size: 0.9rem; text-align: left; display: inline-block; }
        .upload-zone {
            border: 2px dashed var(--border-color); border-radius: var(--radius);
            padding: 40px; cursor: pointer; transition: var(--transition); margin-bottom: 15px;
        }
        .upload-zone:hover { border-color: var(--primary-color); background: rgba(66, 153, 225, 0.05); }
        .upload-zone.drag-over { border-color: var(--primary-color); background: rgba(66, 153, 225, 0.1); }
        .upload-icon { font-size: 3rem; margin-bottom: 15px; }
        .file-input { display: none; }

        /* ===== é¢˜åº“åˆ—è¡¨æ ·å¼ ===== */
        .quiz-list-card { background: var(--card-bg); border-radius: var(--radius); padding: 25px; box-shadow: var(--shadow); }
        .quiz-list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .quiz-list { display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto; }
        .quiz-item {
            display: flex; align-items: center; padding: 15px;
            background: var(--bg-color); border-radius: 8px; cursor: pointer;
            transition: var(--transition); border: 2px solid transparent;
        }
        .quiz-item:hover { border-color: var(--primary-color); }
        .quiz-item.selected { border-color: var(--primary-color); background: rgba(66, 153, 225, 0.1); }
        .quiz-item-radio {
            width: 20px; height: 20px; border: 2px solid var(--border-color);
            border-radius: 50%; margin-right: 15px; display: flex; align-items: center; justify-content: center;
        }
        .quiz-item.selected .quiz-item-radio { border-color: var(--primary-color); background: var(--primary-color); }
        .quiz-item.selected .quiz-item-radio::after { content: ''; width: 8px; height: 8px; background: white; border-radius: 50%; }
        .quiz-item-info { flex: 1; min-width: 0; }
        .quiz-item-name { font-weight: 600; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        .quiz-item-meta { font-size: 0.85rem; color: var(--text-secondary); }
        .quiz-item-btn.delete {
            padding: 6px 12px; border: none; border-radius: 6px; font-size: 0.85rem;
            cursor: pointer; background: var(--error-color); color: white; transition: var(--transition);
        }
        .empty-list { text-align: center; padding: 40px; color: var(--text-secondary); }

        /* ===== æŒ‰é’®æ ·å¼ ===== */
        .start-section { display: flex; justify-content: center; gap: 15px; margin-top: 25px; flex-wrap: wrap; }
        .start-btn, .wrong-btn {
            padding: 15px 40px; font-size: 1.1rem; font-weight: 600; border: none;
            border-radius: var(--radius); color: white; cursor: pointer;
            transition: var(--transition); box-shadow: var(--shadow);
        }
        .start-btn { background: linear-gradient(135deg, var(--primary-color), #667eea); }
        .wrong-btn { background: linear-gradient(135deg, var(--error-color), #c53030); }
        .start-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .start-btn:hover:not(:disabled), .wrong-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }

        /* ===== ç­”é¢˜é¡µé¢æ ·å¼ ===== */
        .quiz-page { background: var(--card-bg); border-radius: var(--radius); padding: 30px; box-shadow: var(--shadow); }
        .back-btn {
            padding: 10px 20px; border: none; border-radius: 8px;
            background: var(--bg-color); color: var(--text-color); cursor: pointer;
            transition: var(--transition);
        }
        /* é¡¶éƒ¨å¯¼èˆªæ å¸ƒå±€è°ƒæ•´ */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }
        .timer {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        .question-type-tag {
            display: inline-block;
            padding: 5px 15px;
            background: var(--primary-color);
            color: white;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        .question-info {
            margin-bottom: 25px; /* å¢åŠ é—´è· */
        }
        /* é¢˜å¹²æ ·å¼ä¼˜åŒ– - æ— åº•è‰²ã€å·¦å¯¹é½ */
        .question-content {
            font-size: 1.2rem;
            line-height: 1.8;
            margin-bottom: 30px; /* å¢åŠ ä¸é€‰é¡¹çš„é—´è· */
            padding: 0;
            background: transparent;
            border-radius: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            text-align: left;
        }
        
        /* å…±ç”¨é¢˜å¹²æ ·å¼ */
        .common-stem-wrapper {
            background: rgba(66, 153, 225, 0.1);
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 1.1rem;
            color: var(--text-color);
        }

        /* è¿›åº¦æ¡ */
        .progress-bar { height: 8px; background: var(--bg-color); border-radius: 4px; margin-bottom: 25px; cursor: pointer; position: relative; }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, var(--primary-color), #667eea);
            border-radius: 4px; transition: width 0.3s ease;
        }

        /* é€‰é¡¹æ ·å¼ä¼˜åŒ– - å»æ‰åœ†å½¢å•é€‰æ¡†ã€å­—æ¯å·¦å¯¹é½ã€è½»å¾®è¾¹æ¡† */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 15px; /* å¢åŠ é€‰é¡¹é—´è· */
            margin-bottom: 35px; /* å¢åŠ ä¸æŒ‰é’®çš„é—´è· */
        }
        .option-item {
            display: flex;
            align-items: flex-start;
            padding: 18px 20px;
            background: transparent; /* å–æ¶ˆæµ…ç°èƒŒæ™¯ */
            border: 2px solid var(--border-color); /* è½»å¾®è¾¹æ¡† */
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }
        .option-item:hover:not(.disabled) {
            border-color: var(--primary-color);
            background: rgba(66, 153, 225, 0.05);
        }
        .option-item.selected {
            border-color: var(--primary-color);
            background: rgba(66, 153, 225, 0.1);
        }
        .option-item.correct {
            border-color: var(--success-color);
            background: rgba(72, 187, 120, 0.1);
        }
        .option-item.incorrect {
            border-color: var(--error-color);
            background: rgba(245, 101, 101, 0.1);
        }
        .option-item.disabled { cursor: not-allowed; }
        /* é€‰é¡¹å­—æ¯æ ·å¼ - å»æ‰åœ†å½¢èƒŒæ™¯ï¼Œå·¦å¯¹é½ */
        .option-label {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-right: 15px;
            font-weight: 600;
            flex-shrink: 0;
            color: var(--primary-color);
        }
        .option-item.selected .option-label {
            color: var(--primary-color);
        }
        .option-item.correct .option-label {
            color: var(--success-color);
        }
        .option-item.incorrect .option-label {
            color: var(--error-color);
        }
        .option-text {
            flex: 1;
            line-height: 1.6;
            padding-top: 1px;
        }
        /* é€‰é¡¹åˆ¤æ–­å›¾æ ‡ */
        .option-result {
            margin-left: 10px;
            font-size: 1.2rem;
            display: none;
        }
        .option-item.correct .option-result,
        .option-item.incorrect .option-result {
            display: block;
        }

        /* ç®€ç­”é¢˜ä¼˜åŒ– */
        .essay-answer-container {
            display: none;
            margin-bottom: 35px; /* å¢åŠ é—´è· */
        }
        .answer-input {
            width: 100%;
            min-height: 80px;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--bg-color);
            color: var(--text-color);
            transition: var(--transition);
            resize: vertical;
        }
        .answer-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* åº•éƒ¨æ“ä½œæ ä¼˜åŒ– */
        .submit-section {
            margin-bottom: 20px;
            text-align: center;
        }
        .submit-btn {
            padding: 12px 40px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            background: var(--primary-color);
            color: white;
            width: auto;
        }
        .action-buttons {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }
        .action-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            min-width: 120px;
        }
        .action-btn.primary {
            background: var(--primary-color);
            color: white;
        }
        .action-btn.secondary {
            background: var(--bg-color);
            color: var(--text-color);
        }
        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* è§£æ */
        .analysis-container {
            background: var(--bg-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
            margin-top: 20px;
        }
        .analysis-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        .analysis-content {
            line-height: 1.8;
            white-space: pre-wrap;
        }

        /* é”™é¢˜æœ¬ä¸ç»“ç®— */
        .wrong-questions-page {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 30px;
        }
        .wrong-question-item {
            background: var(--bg-color);
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid var(--error-color);
            margin-bottom: 15px;
        }
        .wrong-question-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .wrong-answer-row {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
        }
        .stats-section {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background: var(--bg-color);
            padding: 15px;
            text-align: center;
            border-radius: 8px;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }
        .stat-value.correct {
            color: var(--success-color);
        }
        .stat-value.incorrect {
            color: var(--error-color);
        }

        /* Toast & Modal */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
        }
        .toast {
            padding: 15px 25px;
            background: rgba(0,0,0,0.8);
            color: white;
            border-radius: 8px;
            margin-bottom: 10px;
            animation: slideIn 0.3s;
        }
        .toast.success {
            background: var(--success-color);
        }
        .toast.error {
            background: var(--error-color);
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: 0.3s;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        .modal-btn {
            padding: 10px 25px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }
        .modal-btn.confirm {
            background: var(--primary-color);
            color: white;
        }

        @media (max-width: 768px) {
            .stats-section {
                grid-template-columns: 1fr 1fr;
            }
            .action-buttons {
                flex-direction: column;
            }
            .nav-buttons {
                flex-wrap: wrap;
            }
            .timer {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>å¤šåŠŸèƒ½æ™ºèƒ½åˆ·é¢˜ç³»ç»Ÿ</h1>
            <div class="header-controls">
                <button id="themeToggleBtn" class="theme-btn">åˆ‡æ¢æ·±è‰²æ¨¡å¼</button>
            </div>
        </header>

        <div id="uploadPage" class="page active">
            <div class="upload-page">
                <div class="upload-card">
                    <h2 class="upload-title">ä¸Šä¼ é¢˜åº“å¼€å§‹åˆ·é¢˜</h2>
                    <p class="upload-desc">
                        <strong>æ”¯æŒæ ¼å¼ (TXT)ï¼š</strong><br>
                        1. <strong>A/Xå‹é€‰æ‹©é¢˜</strong>ï¼šé¢˜å¹²|é€‰é¡¹A|...|é€‰é¡¹N|ç­”æ¡ˆ|è§£æ<br>
                        2. <strong>B/ç»¼åˆé¢˜</strong>ï¼šå…±ç”¨é¢˜å¹²|å°é¢˜1|é€‰é¡¹...|ç­”æ¡ˆ|å°é¢˜2...<br>
                        3. <strong>ç®€ç­”é¢˜</strong>ï¼šQ:é—®é¢˜ (æ¢è¡Œ) A:ç­”æ¡ˆ
                    </p>
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">ğŸ“</div>
                        <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œä¸Šä¼ </div>
                        <div class="upload-hint">æ”¯æŒæ‰¹é‡ä¸Šä¼ å¤šä¸ª .txt æ–‡ä»¶</div>
                        <input type="file" id="fileInput" class="file-input" accept=".txt" multiple>
                    </div>
                </div>

                <div class="quiz-list-card">
                    <div class="quiz-list-header">
                        <h3 class="quiz-list-title">å·²ä¸Šä¼ çš„é¢˜åº“</h3>
                    </div>
                    <div class="quiz-list" id="quizList">
                        <div class="empty-list">
                            <div class="empty-list-icon">ğŸ“š</div>
                            <p>è¿˜æ²¡æœ‰ä¸Šä¼ é¢˜åº“ï¼Œå¿«æ¥ä¸Šä¼ å§ï¼</p>
                        </div>
                    </div>
                    <div class="start-section">
                        <button id="startQuizBtn" class="start-btn" disabled>å¼€å§‹åˆ·é¢˜</button>
                        <button id="wrongBookBtn" class="wrong-btn">æˆ‘çš„é”™é¢˜æœ¬</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="quizPage" class="page">
            <div class="quiz-page">
                <!-- é¡¶éƒ¨å¯¼èˆªæ é‡æ„ - é€€å‡ºæŒ‰é’® + é¢˜å‹æ ‡ç­¾ + è®¡æ—¶å™¨ -->
                <div class="nav-buttons">
                    <button id="quitQuizBtn" class="back-btn">é€€å‡ºç­”é¢˜</button>
                    <span id="questionType" class="question-type-tag">å•é€‰é¢˜</span>
                    <div class="timer" id="timer">00:00</div>
                </div>
                
                <div class="progress-section">
                    <div class="progress-header">
                        <span id="progressText">è¿›åº¦: 1/10</span>
                        <span id="scoreText">å¾—åˆ†: 0</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progressBar" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <div id="questionContainer">
                    <div class="question-info"></div>
                    <div id="questionContent" class="question-content"></div>
                    
                    <div id="optionsContainer" class="options-container"></div>
                    
                    <div id="essayContainer" class="essay-answer-container">
                        <textarea id="essayInput" class="answer-input" placeholder="å¯ä»¥åœ¨æ­¤è¾“å…¥å…³é”®è¯ï¼ˆéå¿…å¡«ï¼‰..."></textarea>
                    </div>

                    <!-- æäº¤æŒ‰é’®å•ç‹¬åŒºåŸŸ -->
                    <div class="submit-section">
                        <button id="submitBtn" class="submit-btn primary">æäº¤ç­”æ¡ˆ</button>
                    </div>
                    
                    <!-- ä¸Šä¸‹é¢˜æŒ‰é’®å¸ƒå±€è°ƒæ•´ -->
                    <div class="action-buttons">
                        <button id="prevBtn" class="action-btn secondary">ä¸Šä¸€é¢˜</button>
                        <button id="nextBtn" class="action-btn primary">ä¸‹ä¸€é¢˜</button>
                    </div>

                    <div id="analysisContainer" class="analysis-container">
                        <div class="analysis-title">ğŸ’¡ ç­”æ¡ˆè§£æ</div>
                        <div id="analysisContent" class="analysis-content"></div>
                    </div>
                </div>
                
                <div id="resultContainer" style="display: none; text-align: center;">
                    <div class="stat-icon" style="font-size: 4rem; margin-bottom: 20px;">ğŸ‰</div>
                    <h2 style="margin-bottom: 20px;">æœ¬æ¬¡ç»ƒä¹ å®Œæˆ</h2>
                    <div class="stats-section">
                        <div class="stat-card">
                            <div class="stat-value total" id="resultTotal">0</div>
                            <div class="stat-label">æ€»é¢˜ç›®</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value correct" id="resultCorrect">0</div>
                            <div class="stat-label">æ­£ç¡®</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value incorrect" id="resultWrong">0</div>
                            <div class="stat-label">é”™è¯¯</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="resultScore">0</div>
                            <div class="stat-label">å¾—åˆ†</div>
                        </div>
                    </div>
                    <div class="start-section">
                        <button id="restartBtn" class="start-btn">å†æ¥ä¸€æ¬¡</button>
                        <button id="homeBtn" class="wrong-btn" style="background: var(--bg-color); color: var(--text-color);">è¿”å›ä¸»é¡µ</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="wrongPage" class="page">
            <div class="wrong-questions-page">
                <div class="wrong-questions-header">
                    <h2 class="wrong-questions-title">æˆ‘çš„é”™é¢˜æœ¬</h2>
                    <button id="backFromWrongBtn" class="back-btn" style="margin-bottom: 0;">è¿”å›ä¸»é¡µ</button>
                </div>
                
                <div id="wrongList" class="wrong-questions-list"></div>
                
                <div id="emptyWrong" class="empty-wrong" style="display:none;">
                    <div class="empty-wrong-icon">âœ¨</div>
                    <p>å¤ªæ£’äº†ï¼ç›®å‰æ²¡æœ‰é”™é¢˜è®°å½•</p>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button id="clearWrongBtn" class="clear-wrong-btn">æ¸…ç©ºé”™é¢˜æœ¬</button>
                </div>
            </div>
        </div>

        <div id="confirmModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="modal-title" id="modalTitle">æç¤º</h3>
                <p class="modal-message" id="modalMessage">ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
                <div class="modal-buttons">
                    <button id="modalCancel" class="modal-btn cancel">å–æ¶ˆ</button>
                    <button id="modalConfirm" class="modal-btn confirm">ç¡®å®š</button>
                </div>
            </div>
        </div>

        <div id="toastContainer" class="toast-container"></div>
    </div>

<script>
    // ===== å¸¸é‡å®šä¹‰ =====
    const CONST = {
        ANSWER_OPTIONS: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'],
        AUTO_NEXT_DELAY: 1000, // è‡ªåŠ¨è·³è½¬å»¶è¿Ÿ (æ¯«ç§’)
        CORRECT_ICON: 'âœ…',
        INCORRECT_ICON: 'âŒ'
    };

    // ===== æ ¸å¿ƒçŠ¶æ€ç®¡ç† =====
    const state = {
        quizzes: [],           // é¢˜åº“åˆ—è¡¨
        currentQuizIndex: -1,  // å½“å‰é¢˜åº“ç´¢å¼•
        questions: [],         // å½“å‰é¢˜ç›®åˆ—è¡¨
        userAnswers: {},       // ç”¨æˆ·ä½œç­”è®°å½•
        currentQuestionIndex: 0,
        score: 0,
        correctCount: 0,
        wrongCount: 0,
        wrongQuestions: [],    // é”™é¢˜é›†
        timer: 0,
        timerInterval: null,
        theme: 'light',
        isDragging: false,     // è¿›åº¦æ¡æ‹–æ‹½çŠ¶æ€
        isAutoNexting: false,  // æ˜¯å¦æ­£åœ¨è‡ªåŠ¨è·³è½¬
        isAnswered: false      // å½“å‰é¢˜ç›®æ˜¯å¦å·²ä½œç­”
    };

    // ===== DOM å…ƒç´ è·å– =====
    const elements = {
        uploadPage: document.getElementById('uploadPage'),
        quizPage: document.getElementById('quizPage'),
        wrongPage: document.getElementById('wrongPage'),
        themeToggleBtn: document.getElementById('themeToggleBtn'),
        fileInput: document.getElementById('fileInput'),
        uploadZone: document.getElementById('uploadZone'),
        quizList: document.getElementById('quizList'),
        startQuizBtn: document.getElementById('startQuizBtn'),
        wrongBookBtn: document.getElementById('wrongBookBtn'),
        timer: document.getElementById('timer'),
        progressSection: document.querySelector('.progress-bar'),
        progressText: document.getElementById('progressText'),
        scoreText: document.getElementById('scoreText'),
        progressBar: document.getElementById('progressBar'),
        questionType: document.getElementById('questionType'),
        questionContent: document.getElementById('questionContent'),
        optionsContainer: document.getElementById('optionsContainer'),
        essayContainer: document.getElementById('essayContainer'),
        essayInput: document.getElementById('essayInput'),
        submitBtn: document.getElementById('submitBtn'),
        nextBtn: document.getElementById('nextBtn'),
        prevBtn: document.getElementById('prevBtn'),
        quitQuizBtn: document.getElementById('quitQuizBtn'),
        analysisContainer: document.getElementById('analysisContainer'),
        analysisContent: document.getElementById('analysisContent'),
        questionContainer: document.getElementById('questionContainer'),
        resultContainer: document.getElementById('resultContainer'),
        resultTotal: document.getElementById('resultTotal'),
        resultCorrect: document.getElementById('resultCorrect'),
        resultWrong: document.getElementById('resultWrong'),
        resultScore: document.getElementById('resultScore'),
        restartBtn: document.getElementById('restartBtn'),
        homeBtn: document.getElementById('homeBtn'),
        wrongList: document.getElementById('wrongList'),
        emptyWrong: document.getElementById('emptyWrong'),
        backFromWrongBtn: document.getElementById('backFromWrongBtn'),
        clearWrongBtn: document.getElementById('clearWrongBtn'),
        confirmModal: document.getElementById('confirmModal'),
        modalTitle: document.getElementById('modalTitle'),
        modalMessage: document.getElementById('modalMessage'),
        modalConfirm: document.getElementById('modalConfirm'),
        modalCancel: document.getElementById('modalCancel'),
        toastContainer: document.getElementById('toastContainer')
    };

    // ===== åˆå§‹åŒ– =====
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        initTheme();
        renderQuizList();
        setupEventListeners();
    });

    // ===== æ•°æ®å­˜å‚¨ =====
    function loadData() {
        try {
            state.quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
            state.wrongQuestions = JSON.parse(localStorage.getItem('wrongQuestions') || '[]');
            state.theme = localStorage.getItem('theme') || 'light';
        } catch (e) { console.error("åŠ è½½æ•°æ®å¤±è´¥", e); }
    }
    function saveData() {
        localStorage.setItem('quizzes', JSON.stringify(state.quizzes));
        localStorage.setItem('wrongQuestions', JSON.stringify(state.wrongQuestions));
        localStorage.setItem('theme', state.theme);
    }

    // ===== ä¸»é¢˜æ§åˆ¶ =====
    function initTheme() {
        if (state.theme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            elements.themeToggleBtn.textContent = 'åˆ‡æ¢æµ…è‰²æ¨¡å¼';
        }
    }
    elements.themeToggleBtn.addEventListener('click', () => {
        state.theme = state.theme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', state.theme);
        elements.themeToggleBtn.textContent = state.theme === 'light' ? 'åˆ‡æ¢æ·±è‰²æ¨¡å¼' : 'åˆ‡æ¢æµ…è‰²æ¨¡å¼';
        saveData();
    });

    // ===== æ–‡ä»¶å¤„ç†ä¸è§£æ (æ ¸å¿ƒè§£æå™¨å‡çº§ç‰ˆ) =====
    elements.uploadZone.addEventListener('click', () => elements.fileInput.click());
    elements.uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); elements.uploadZone.classList.add('drag-over'); });
    elements.uploadZone.addEventListener('dragleave', () => elements.uploadZone.classList.remove('drag-over'));
    elements.uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        elements.uploadZone.classList.remove('drag-over');
        handleFiles(e.dataTransfer.files);
    });
    elements.fileInput.addEventListener('change', (e) => { handleFiles(e.target.files); e.target.value = ''; });

    function handleFiles(files) {
        if (!files.length) return;
        Array.from(files).forEach(file => {
            if (!file.name.toLowerCase().endsWith('.txt')) return showToast('è¯·ä¸Šä¼  .txt æ–‡ä»¶', 'error');
            const reader = new FileReader();
            reader.onload = (e) => {
                const questions = parseQuestionsAdvanced(e.target.result);
                if (questions.length > 0) {
                    state.quizzes.push({
                        id: Date.now() + Math.random(),
                        name: file.name.replace('.txt', ''),
                        questions: questions,
                        date: new Date().toLocaleDateString()
                    });
                    saveData();
                    renderQuizList();
                    showToast(`å¯¼å…¥æˆåŠŸ: ${file.name} (${questions.length}é¢˜)`, 'success');
                } else {
                    showToast(`${file.name} è§£æå¤±è´¥æˆ–ä¸ºç©º`, 'error');
                }
            };
            reader.readAsText(file);
        });
    }

    // æ™ºèƒ½è§£æé€»è¾‘
    function parseQuestionsAdvanced(text) {
        const lines = text.replace(/\r\n/g, '\n').split('\n').filter(l => l.trim());
        const result = [];
        let essayBuffer = { q: null, a: '' };

        lines.forEach(line => {
            line = line.trim();
            if(!line) return;

            // 1. ç®€ç­”é¢˜
            if(line.match(/^Q[:ï¼š]/i)) {
                if(essayBuffer.q) result.push(createEssay(essayBuffer));
                essayBuffer = { q: line.replace(/^Q[:ï¼š]/i, '').trim(), a: '' };
                return;
            }
            if(line.match(/^A[:ï¼š]/i) && essayBuffer.q) {
                essayBuffer.a += line.replace(/^A[:ï¼š]/i, '').trim() + '\n';
                return;
            }
            if(essayBuffer.q && !line.includes('|')) {
                essayBuffer.a += line + '\n';
                return;
            }
            if(essayBuffer.q && line.includes('|')) {
                result.push(createEssay(essayBuffer));
                essayBuffer = { q: null, a: '' };
            }

            // 2. é€‰æ‹©é¢˜ (å«å…±ç”¨é¢˜å¹²é€»è¾‘)
            if(line.includes('|')) {
                const parts = line.split('|').map(p => p.trim());
                // æŸ¥æ‰¾æ‰€æœ‰ç­”æ¡ˆä½ç½® (ç‰¹å¾: é•¿åº¦<10, å…¨ä¸ºå­—æ¯æˆ–é€—å·)
                const answerIndices = [];
                parts.forEach((p, idx) => {
                    if(idx > 0 && idx < parts.length - 1) {
                        if(/^[A-H]+([,ï¼Œ][A-H]+)*$/i.test(p) && p.length < 10) {
                            answerIndices.push(idx);
                        }
                    }
                });

                if(answerIndices.length === 0) return; 

                const analysis = parts[parts.length - 1];
                let commonStem = "";

                if(answerIndices.length > 1) {
                    commonStem = parts[0]; // ç¬¬ä¸€ä¸ªéƒ¨åˆ†æ˜¯å…±ç”¨é¢˜å¹²
                    let startIdx = 1;
                    answerIndices.forEach(ansIdx => {
                        const qParts = parts.slice(startIdx, ansIdx + 1);
                        if(qParts.length > 1) {
                            result.push(createChoice(
                                qParts[0], 
                                qParts.slice(1, -1), 
                                qParts[qParts.length - 1], 
                                analysis, 
                                commonStem
                            ));
                        }
                        startIdx = ansIdx + 1;
                    });
                } else {
                    const ansIdx = answerIndices[0];
                    result.push(createChoice(
                        parts[0],
                        parts.slice(1, ansIdx),
                        parts[ansIdx],
                        analysis,
                        ""
                    ));
                }
            }
        });
        if(essayBuffer.q) result.push(createEssay(essayBuffer));
        return result;
    }

    function createChoice(content, options, answerStr, analysis, commonStem) {
        // æ¸…ç†ç­”æ¡ˆå­—ç¬¦ä¸²ï¼Œè½¬ä¸ºå¤§å†™æ•°ç»„
        const correctAnswers = answerStr.replace(/ï¼Œ/g, ',').toUpperCase().split(/[, ]+/).filter(x => x);
        const isMulti = correctAnswers.length > 1;
        return {
            type: isMulti ? 'multiple' : 'choice',
            typeText: isMulti ? 'å¤šé€‰é¢˜' : 'å•é€‰é¢˜',
            content: content,
            options: options,
            correctAnswers: correctAnswers, // Array
            answer: answerStr, // String display
            analysis: analysis,
            commonStem: commonStem
        };
    }

    function createEssay(buffer) {
        return {
            type: 'essay',
            typeText: 'ç®€ç­”é¢˜',
            content: buffer.q,
            options: [],
            answer: buffer.a.trim(),
            correctAnswers: [],
            analysis: 'è¯·æ ¸å¯¹å‚è€ƒç­”æ¡ˆ'
        };
    }

    // ===== é¢˜åº“åˆ—è¡¨æ¸²æŸ“ =====
    function renderQuizList() {
        elements.quizList.innerHTML = '';
        if (state.quizzes.length === 0) {
            elements.quizList.innerHTML = `<div class="empty-list"><div class="empty-list-icon">ğŸ“š</div><p>è¿˜æ²¡æœ‰ä¸Šä¼ é¢˜åº“ï¼Œæ”¯æŒæ‰¹é‡ä¸Šä¼ ï¼</p></div>`;
            elements.startQuizBtn.disabled = true;
            return;
        }
        state.quizzes.forEach((quiz, index) => {
            const item = document.createElement('div');
            item.className = `quiz-item ${state.currentQuizIndex === index ? 'selected' : ''}`;
            item.onclick = (e) => { if (!e.target.closest('.delete')) selectQuiz(index); };
            item.innerHTML = `
                <div class="quiz-item-radio"></div>
                <div class="quiz-item-info">
                    <div class="quiz-item-name">${quiz.name}</div>
                    <div class="quiz-item-meta">${quiz.questions.length} é¢˜ â€¢ ${quiz.date}</div>
                </div>
                <button class="quiz-item-btn delete" onclick="deleteQuiz(${index})">åˆ é™¤</button>
            `;
            elements.quizList.appendChild(item);
        });
        elements.startQuizBtn.disabled = state.currentQuizIndex === -1;
    }
    function selectQuiz(idx) { 
        state.currentQuizIndex = idx; 
        renderQuizList(); 
    }
    window.deleteQuiz = function(idx) {
        showModal('ç¡®è®¤åˆ é™¤', `ç¡®å®šè¦åˆ é™¤é¢˜åº“ "${state.quizzes[idx].name}" å—ï¼Ÿ`, () => {
            state.quizzes.splice(idx, 1);
            if (state.currentQuizIndex === idx) state.currentQuizIndex = -1;
            saveData();
            renderQuizList();
            showToast('é¢˜åº“å·²åˆ é™¤', 'success');
        });
    };

    // ===== ç­”é¢˜é€»è¾‘ =====
    elements.startQuizBtn.addEventListener('click', startQuiz);
    elements.quitQuizBtn.addEventListener('click', () => {
        showModal('é€€å‡ºç­”é¢˜', 'ç¡®å®šè¦é€€å‡ºå½“å‰ç­”é¢˜å—ï¼Ÿè¿›åº¦å°†è¢«é‡ç½®', () => {
            stopTimer();
            resetQuizState();
            elements.uploadPage.classList.add('active');
            elements.quizPage.classList.remove('active');
        });
    });

    function startQuiz() {
        if (state.currentQuizIndex === -1) return;
        const quiz = state.quizzes[state.currentQuizIndex];
        state.questions = [...quiz.questions];
        resetQuizState();
        
        elements.uploadPage.classList.remove('active');
        elements.quizPage.classList.add('active');
        
        startTimer();
        renderQuestion();
        updateProgress();
    }

    function resetQuizState() {
        state.userAnswers = {};
        state.currentQuestionIndex = 0;
        state.score = 0;
        state.correctCount = 0;
        state.wrongCount = 0;
        state.timer = 0;
        state.isAnswered = false;
        stopTimer();
    }

    function startTimer() {
        stopTimer();
        state.timerInterval = setInterval(() => {
            state.timer++;
            const minutes = Math.floor(state.timer / 60).toString().padStart(2, '0');
            const seconds = (state.timer % 60).toString().padStart(2, '0');
            elements.timer.textContent = `${minutes}:${seconds}`;
        }, 1000);
    }

    function stopTimer() {
        if (state.timerInterval) clearInterval(state.timerInterval);
        state.timerInterval = null;
    }

    function renderQuestion() {
        if (state.currentQuestionIndex >= state.questions.length) {
            showResult();
            return;
        }

        const question = state.questions[state.currentQuestionIndex];
        state.isAnswered = !!state.userAnswers[state.currentQuestionIndex];
        
        // é‡ç½®UIçŠ¶æ€
        elements.optionsContainer.innerHTML = '';
        elements.essayContainer.style.display = 'none';
        elements.analysisContainer.style.display = 'none';
        elements.submitBtn.style.display = 'block';
        
        // æ›´æ–°é¢˜å‹æ ‡ç­¾
        elements.questionType.textContent = question.typeText;
        
        // æ¸²æŸ“å…±ç”¨é¢˜å¹²
        let questionHtml = '';
        if (question.commonStem) {
            questionHtml += `<div class="common-stem-wrapper">${question.commonStem}</div>`;
        }
        questionHtml += question.content;
        elements.questionContent.innerHTML = questionHtml;
        
        // æ¸²æŸ“é€‰é¡¹ï¼ˆé€‰æ‹©é¢˜/å¤šé€‰é¢˜ï¼‰
        if (question.type === 'choice' || question.type === 'multiple') {
            question.options.forEach((option, idx) => {
                const optionLetter = CONST.ANSWER_OPTIONS[idx];
                const isSelected = state.userAnswers[state.currentQuestionIndex]?.includes(optionLetter) || false;
                const isCorrect = question.correctAnswers.includes(optionLetter);
                const isIncorrect = state.isAnswered && isSelected && !isCorrect;
                
                const optionItem = document.createElement('div');
                optionItem.className = `option-item ${isSelected ? 'selected' : ''} ${state.isAnswered ? (isCorrect ? 'correct' : (isIncorrect ? 'incorrect' : '')) : ''} ${state.isAnswered ? 'disabled' : ''}`;
                optionItem.innerHTML = `
                    <div class="option-label">${optionLetter}</div>
                    <div class="option-text">${option}</div>
                    <div class="option-result">${isCorrect ? CONST.CORRECT_ICON : (isIncorrect ? CONST.INCORRECT_ICON : '')}</div>
                `;
                
                if (!state.isAnswered) {
                    optionItem.addEventListener('click', () => {
                        if (question.type === 'choice') {
                            // å•é€‰é¢˜ - å•é€‰
                            Array.from(elements.optionsContainer.children).forEach(item => {
                                item.classList.remove('selected');
                            });
                            optionItem.classList.add('selected');
                        } else {
                            // å¤šé€‰é¢˜ - å¤šé€‰
                            optionItem.classList.toggle('selected');
                        }
                    });
                }
                
                elements.optionsContainer.appendChild(optionItem);
            });
        } 
        // æ¸²æŸ“ç®€ç­”é¢˜
        else if (question.type === 'essay') {
            elements.essayContainer.style.display = 'block';
            elements.essayInput.value = state.userAnswers[state.currentQuestionIndex] || '';
            // ç®€ç­”é¢˜æäº¤æŒ‰é’®æ”¹ä¸ºæ˜¾ç¤ºè§£æ
            elements.submitBtn.textContent = 'æŸ¥çœ‹è§£æ';
            // ç®€ç­”é¢˜ä¸Šä¸‹é¢˜æŒ‰é’®æ— é™åˆ¶
            elements.prevBtn.disabled = false;
            elements.nextBtn.disabled = false;
        } else {
            elements.submitBtn.textContent = 'æäº¤ç­”æ¡ˆ';
        }

        // æ›´æ–°æäº¤æŒ‰é’®çŠ¶æ€
        if (state.isAnswered) {
            elements.submitBtn.style.display = 'none';
            // å¦‚æœæ˜¯ç­”é”™çš„å•é€‰é¢˜ï¼Œè‡ªåŠ¨å±•å¼€è§£æ
            if (question.type === 'choice' && !isAnswerCorrect()) {
                elements.analysisContainer.style.display = 'block';
                elements.analysisContent.textContent = question.analysis || 'æš‚æ— è§£æ';
            }
        } else {
            elements.submitBtn.textContent = question.type === 'essay' ? 'æŸ¥çœ‹è§£æ' : 'æäº¤ç­”æ¡ˆ';
        }

        // æ›´æ–°ä¸Šä¸‹é¢˜æŒ‰é’®çŠ¶æ€ï¼ˆéç®€ç­”é¢˜æŒ‰åŸæœ‰é€»è¾‘ï¼Œç®€ç­”é¢˜æ— é™åˆ¶ï¼‰
        if (question.type !== 'essay') {
            elements.prevBtn.disabled = state.currentQuestionIndex === 0;
            elements.nextBtn.disabled = state.isAnswered ? false : true;
        } else {
            elements.prevBtn.disabled = false;
            elements.nextBtn.disabled = false;
        }
    }

    function updateProgress() {
        const progress = ((state.currentQuestionIndex + 1) / state.questions.length) * 100;
        elements.progressBar.style.width = `${progress}%`;
        elements.progressText.textContent = `è¿›åº¦: ${state.currentQuestionIndex + 1}/${state.questions.length}`;
        elements.scoreText.textContent = `å¾—åˆ†: ${state.score}`;
    }

    function getSelectedAnswers() {
        const selectedOptions = Array.from(elements.optionsContainer.querySelectorAll('.option-item.selected'));
        return selectedOptions.map(item => {
            return item.querySelector('.option-label').textContent;
        });
    }

    function isAnswerCorrect() {
        const question = state.questions[state.currentQuestionIndex];
        const userAnswer = state.userAnswers[state.currentQuestionIndex] || [];
        
        if (question.type === 'essay') return true; // ç®€ç­”é¢˜ä¸åˆ¤æ–­å¯¹é”™
        
        // æ£€æŸ¥ç­”æ¡ˆæ˜¯å¦æ­£ç¡®
        if (userAnswer.length !== question.correctAnswers.length) return false;
        return question.correctAnswers.every(ans => userAnswer.includes(ans));
    }

    function submitAnswer() {
        const question = state.questions[state.currentQuestionIndex];
        state.isAnswered = true;
        
        // å¤„ç†ä¸åŒé¢˜å‹
        if (question.type === 'choice' || question.type === 'multiple') {
            // é€‰æ‹©é¢˜/å¤šé€‰é¢˜
            const selectedAnswers = getSelectedAnswers();
            state.userAnswers[state.currentQuestionIndex] = selectedAnswers;
            
            // æ ‡è®°æ­£ç¡®/é”™è¯¯é€‰é¡¹
            question.options.forEach((option, idx) => {
                const optionLetter = CONST.ANSWER_OPTIONS[idx];
                const optionItem = elements.optionsContainer.children[idx];
                const isCorrect = question.correctAnswers.includes(optionLetter);
                const isSelected = selectedAnswers.includes(optionLetter);
                
                optionItem.classList.remove('selected');
                optionItem.classList.add('disabled');
                
                if (isCorrect) {
                    optionItem.classList.add('correct');
                    optionItem.querySelector('.option-result').textContent = CONST.CORRECT_ICON;
                } else if (isSelected && !isCorrect) {
                    optionItem.classList.add('incorrect');
                    optionItem.querySelector('.option-result').textContent = CONST.INCORRECT_ICON;
                }
            });
            
            // åˆ¤æ–­å¯¹é”™
            const correct = isAnswerCorrect();
            if (correct) {
                state.correctCount++;
                state.score += 10; // æ¯é¢˜10åˆ†
                // å•é€‰é¢˜ç­”å¯¹ - 1ç§’åè‡ªåŠ¨ä¸‹ä¸€é¢˜
                if (question.type === 'choice') {
                    setTimeout(() => {
                        if (!state.isAutoNexting) {
                            state.isAutoNexting = true;
                            nextQuestion();
                            state.isAutoNexting = false;
                        }
                    }, CONST.AUTO_NEXT_DELAY);
                }
            } else {
                state.wrongCount++;
                // ç­”é”™ - è‡ªåŠ¨å±•å¼€è§£æï¼Œä¸è‡ªåŠ¨è·³è½¬
                elements.analysisContainer.style.display = 'block';
                elements.analysisContent.textContent = question.analysis || 'æš‚æ— è§£æ';
                // åŠ å…¥é”™é¢˜æœ¬
                addToWrongQuestions();
            }
        } 
        // ç®€ç­”é¢˜ - æ˜¾ç¤ºè§£æï¼Œä¸è‡ªåŠ¨è·³è½¬
        else if (question.type === 'essay') {
            state.userAnswers[state.currentQuestionIndex] = elements.essayInput.value;
            elements.analysisContainer.style.display = 'block';
            elements.analysisContent.textContent = question.answer || 'æš‚æ— å‚è€ƒç­”æ¡ˆ';
        }
        
        // æ›´æ–°UI
        elements.submitBtn.style.display = 'none';
        elements.nextBtn.disabled = false; // ç­”é”™æ—¶å…è®¸æ‰‹åŠ¨ä¸‹ä¸€é¢˜
        updateProgress();
    }

    function addToWrongQuestions() {
        const question = state.questions[state.currentQuestionIndex];
        const userAnswer = state.userAnswers[state.currentQuestionIndex];
        
        state.wrongQuestions.push({
            id: Date.now() + Math.random(),
            question: question,
            userAnswer: userAnswer,
            quizName: state.quizzes[state.currentQuizIndex].name,
            time: new Date().toLocaleString()
        });
        saveData();
    }

    function prevQuestion() {
        if (state.currentQuestionIndex > 0) {
            state.currentQuestionIndex--;
            renderQuestion();
            updateProgress();
        }
    }

    function nextQuestion() {
        if (state.currentQuestionIndex < state.questions.length - 1) {
            state.currentQuestionIndex++;
            renderQuestion();
            updateProgress();
        } else {
            showResult();
        }
    }

    function showResult() {
        stopTimer();
        elements.questionContainer.style.display = 'none';
        elements.resultContainer.style.display = 'block';
        
        elements.resultTotal.textContent = state.questions.length;
        elements.resultCorrect.textContent = state.correctCount;
        elements.resultWrong.textContent = state.wrongCount;
        elements.resultScore.textContent = state.score;
    }

    // ===== äº‹ä»¶ç›‘å¬ =====
    function setupEventListeners() {
        // æäº¤ç­”æ¡ˆ
        elements.submitBtn.addEventListener('click', submitAnswer);
        
        // ä¸Šä¸‹é¢˜
        elements.prevBtn.addEventListener('click', prevQuestion);
        elements.nextBtn.addEventListener('click', nextQuestion);
        
        // ç»“æœé¡µé¢æŒ‰é’®
        elements.restartBtn.addEventListener('click', startQuiz);
        elements.homeBtn.addEventListener('click', () => {
            elements.resultContainer.style.display = 'none';
            elements.questionContainer.style.display = 'block';
            elements.quizPage.classList.remove('active');
            elements.uploadPage.classList.add('active');
            resetQuizState();
        });
        
        // é”™é¢˜æœ¬
        elements.wrongBookBtn.addEventListener('click', () => {
            elements.uploadPage.classList.remove('active');
            elements.wrongPage.classList.add('active');
            renderWrongQuestions();
        });
        
        elements.backFromWrongBtn.addEventListener('click', () => {
            elements.wrongPage.classList.remove('active');
            elements.uploadPage.classList.add('active');
        });
        
        elements.clearWrongBtn.addEventListener('click', () => {
            showModal('æ¸…ç©ºé”™é¢˜æœ¬', 'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é”™é¢˜è®°å½•å—ï¼Ÿ', () => {
                state.wrongQuestions = [];
                saveData();
                renderWrongQuestions();
                showToast('é”™é¢˜æœ¬å·²æ¸…ç©º', 'success');
            });
        });
        
        // æ¨¡æ€æ¡†
        elements.modalCancel.addEventListener('click', () => {
            elements.confirmModal.classList.remove('active');
        });
        
        // è¿›åº¦æ¡ç‚¹å‡»è·³è½¬
        elements.progressSection.addEventListener('click', (e) => {
            const rect = elements.progressSection.getBoundingClientRect();
            const clickPos = (e.clientX - rect.left) / rect.width;
            const newIndex = Math.floor(clickPos * state.questions.length);
            if (newIndex >= 0 && newIndex < state.questions.length) {
                state.currentQuestionIndex = newIndex;
                renderQuestion();
                updateProgress();
            }
        });
    }

    // ===== é”™é¢˜æœ¬æ¸²æŸ“ =====
    function renderWrongQuestions() {
        if (state.wrongQuestions.length === 0) {
            elements.emptyWrong.style.display = 'block';
            elements.wrongList.innerHTML = '';
            return;
        }
        
        elements.emptyWrong.style.display = 'none';
        elements.wrongList.innerHTML = '';
        
        state.wrongQuestions.forEach((wrongItem, idx) => {
            const question = wrongItem.question;
            const userAnswer = wrongItem.userAnswer;
            
            let wrongHtml = `
                <div class="wrong-question-item">
                    <div class="wrong-question-header">
                        <span>${idx + 1}. ${question.typeText}</span>
                        <span>${wrongItem.time}</span>
                    </div>
                    <div class="wrong-question-content" style="margin-bottom: 10px;">${question.content}</div>
            `;
            
            // æ˜¾ç¤ºç”¨æˆ·ç­”æ¡ˆå’Œæ­£ç¡®ç­”æ¡ˆ
            wrongHtml += `<div class="wrong-answer-row">
                <span style="color: var(--error-color);">ä½ çš„ç­”æ¡ˆï¼š</span>
                <span>${Array.isArray(userAnswer) ? userAnswer.join(',') : userAnswer || 'æœªä½œç­”'}</span>
            </div>`;
            
            wrongHtml += `<div class="wrong-answer-row">
                <span style="color: var(--success-color);">æ­£ç¡®ç­”æ¡ˆï¼š</span>
                <span>${Array.isArray(question.correctAnswers) ? question.correctAnswers.join(',') : question.answer || 'æ— '}</span>
            </div>`;
            
            // æ˜¾ç¤ºè§£æ
            wrongHtml += `<div style="margin-top: 10px;">
                <div class="analysis-title">è§£æï¼š</div>
                <div class="analysis-content">${question.analysis || 'æš‚æ— è§£æ'}</div>
            </div>`;
            
            wrongHtml += `</div>`;
            elements.wrongList.innerHTML += wrongHtml;
        });
    }

    // ===== å·¥å…·å‡½æ•° =====
    function showModal(title, message, confirmCallback) {
        elements.modalTitle.textContent = title;
        elements.modalMessage.textContent = message;
        elements.confirmModal.classList.add('active');
        
        // é‡æ–°ç»‘å®šç¡®è®¤äº‹ä»¶
        elements.modalConfirm.onclick = () => {
            elements.confirmModal.classList.remove('active');
            confirmCallback();
        };
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        elements.toastContainer.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                elements.toastContainer.removeChild(toast);
            }, 300);
        }, 3000);
    }
</script>
</body>
</html>
