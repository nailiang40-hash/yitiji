<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šåŠŸèƒ½æ™ºèƒ½åˆ·é¢˜ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Microsoft Yahei', sans-serif; }
        :root {
            --primary: #2563eb; --success: #10b981; --error: #ef4444; --text: #334155;
            --bg: #f8fafc; --card: #fff; --border: #e2e8f0; --hover: #eff6ff; --progress: #e2e8f0;
            --tag-bg: #e0f2fe; --tag-text: #0369a1; --analysis-bg: #f0f9ff; --analysis-text: #0284c7;
            --stem-bg: #f5fafe; --stem-border: #94a3b8; --essay-bg: #F0F0F2;
            --essay-focus: rgba(0, 122, 255, 0.3); --essay-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        .dark-mode {
            --text: #f1f5f9; --bg: #0f172a; --card: #1e293b; --border: #334155; --hover: #273449;
            --progress: #334155; --tag-bg: #075985; --tag-text: #bae6fd; --analysis-bg: #0c4a6e;
            --analysis-text: #bae6fd; --stem-bg: #1e293b; --stem-border: #64748b;
            --essay-bg: #333336; --essay-focus: rgba(0, 102, 204, 0.3);
        }
        body { background: var(--bg); color: var(--text); line-height: 1.6; min-height: 100vh; padding: 20px; transition: all 0.3s ease; }
        .container { max-width: 900px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 15px; }
        .header h1 { font-size: 24px; font-weight: 600; color: var(--primary); }
        .header-controls { display: flex; gap: 10px; align-items: center; }
        .theme-btn, .quiz-select-btn { padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        
        /* é¡µé¢åˆ‡æ¢æ ·å¼ */
        .page { display: none; }
        .page.active { display: block; }
        
        /* ä¸Šä¼ é¡µé¢æ ·å¼ */
        .upload-page { text-align: center; padding: 40px 20px; }
        .upload-card { background: var(--card); padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 600px; margin: 0 auto; }
        .upload-title { font-size: 22px; margin-bottom: 20px; color: var(--primary); }
        .upload-desc { margin-bottom: 30px; color: #64748b; line-height: 1.8; }
        .upload-btn { padding: 12px 30px; font-size: 18px; margin-bottom: 20px; }
        .quiz-list { margin-top: 30px; text-align: left; max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; }
        .quiz-item { padding: 12px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .quiz-item:last-child { border-bottom: none; }
        .quiz-item:hover { background: var(--hover); }
        .quiz-item.active { background: var(--hover); font-weight: 600; color: var(--primary); }
        .quiz-info { display: flex; flex-direction: column; }
        .quiz-name { font-weight: 500; }
        .quiz-meta { font-size: 12px; color: #64748b; }
        .quiz-actions { display: flex; gap: 10px; }
        .delete-quiz-btn { background: none; border: none; color: var(--error); cursor: pointer; font-size: 16px; opacity: 0.7; }
        .delete-quiz-btn:hover { opacity: 1; }
        .select-quiz-btn { padding: 6px 12px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .start-quiz-btn { margin-top: 30px; padding: 12px 40px; font-size: 18px; background: var(--success); color: white; border: none; border-radius: 8px; cursor: pointer; }
        .start-quiz-btn:disabled { background: var(--border); color: #94a3b8; cursor: not-allowed; }
        
        /* ç­”é¢˜é¡µé¢æ ·å¼ */
        .quiz-page { display: none; }
        .quiz-page.active { display: block; }
        .timer { text-align: right; font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--primary); }
        .question-info { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 16px; font-weight: 600; }
        .question-type-tag { display: inline-block; padding: 4px 12px; background: var(--tag-bg); color: var(--tag-text); border-radius: 20px; font-size: 14px; margin-bottom: 16px; font-weight: 600; }
        .question-content { font-size: 18px; margin-bottom: 24px; line-height: 1.8; }
        .common-stem-wrapper { background: var(--stem-bg); border: 1px solid var(--stem-border); border-left: 4px solid var(--primary); padding: 18px 20px; border-radius: 8px; margin-bottom: 16px; font-size: 17px; color: var(--text); line-height: 1.8; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .options-container { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
        .option-btn { padding: 14px 16px; background: var(--card); border: 1px solid var(--border); border-radius: 6px; text-align: left; cursor: pointer; font-size: 16px; color: var(--text); transition: all 0.2s ease; display: flex; align-items: center; }
        .option-btn:hover { background: var(--hover); }
        .option-btn.selected { background: var(--hover); border-color: var(--primary); }
        .option-btn.correct { background: rgba(16, 185, 129, 0.1); border-color: var(--success); color: var(--success); }
        .option-btn.incorrect { background: rgba(239, 68, 68, 0.1); border-color: var(--error); color: var(--error); }
        .option-letter { display: inline-block; width: 24px; font-weight: 600; margin-right: 12px; }
        .essay-answer-container { margin-bottom: 20px; }
        .answer-input { width: 100%; min-height: 140px; padding: 16px; border-radius: 24px; border: 1px solid transparent; background: var(--essay-bg); color: var(--text); font-size: 1.1rem; line-height: 1.5; resize: none; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .answer-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px var(--essay-focus); }
        .answer-input::placeholder { color: #64748b; }
        .answer-ref-container { display: none; flex-direction: column; gap: 12px; padding: 16px; background: var(--essay-bg); border-radius: 20px; margin-bottom: 20px; animation: fadeIn 0.3s ease; }
        .answer-ref-title { font-size: 1.1rem; font-weight: 600; color: var(--text); }
        .answer-ref-content { font-size: 1.1rem; line-height: 1.5; color: var(--text); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .submit-btn-area { text-align: center; margin-bottom: 30px; }
        .submit-btn { background: var(--success); color: white; font-weight: 600; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-size: 16px; }
        .analysis-btn-area { text-align: center; margin-bottom: 20px; }
        .analysis-btn { background: #6366f1; color: white; font-weight: 600; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-size: 16px; }
        .analysis-btn:disabled { background: var(--border); color: #94a3b8; cursor: not-allowed; }
        .analysis-container { background: var(--analysis-bg); border-left: 4px solid var(--analysis-text); padding: 16px; border-radius: 6px; margin-bottom: 20px; display: none; font-size: 16px; color: var(--analysis-text); line-height: 1.8; }
        .nav-buttons { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .nav-btn { background: var(--primary); color: white; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-size: 16px; }
        .nav-btn:disabled { background: var(--border); color: #94a3b8; cursor: not-allowed; }
        .progress-container { position: relative; height: 8px; background: var(--progress); border-radius: 4px; margin-bottom: 20px; cursor: pointer; }
        .progress-bar { height: 100%; background: var(--primary); border-radius: 4px; transition: width 0.3s ease; width: 0%; }
        .progress-thumb { position: absolute; top: 50%; left: 0%; transform: translate(-50%, -50%); width: 16px; height: 16px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 0 2px white, 0 0 4px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.2s ease; }
        .progress-container:hover .progress-thumb { opacity: 1; }
        .progress-text { position: absolute; right: 0; top: -20px; font-size: 14px; color: #64748b; }
        .stats-area { display: flex; justify-content: space-around; padding-top: 20px; border-top: 1px solid var(--border); }
        .stat-item { font-size: 16px; }
        .stat-item span { font-weight: 600; margin-left: 4px; }
        .back-btn { position: absolute; top: 20px; left: 20px; background: var(--primary); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; }
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; background: #1e293b; color: white; border-radius: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; opacity: 0; transition: opacity 0.3s ease; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--error); }
        .toast.info { background: var(--primary); }
        
        @media (max-width: 600px) {
            .container { padding: 10px; }
            .upload-card { padding: 20px; }
            .back-btn { position: static; margin-bottom: 20px; display: block; }
            .common-stem-wrapper { padding: 15px 16px; font-size: 16px; margin-bottom: 12px; max-height: 300px; overflow-y: auto; }
            .question-content { font-size: 17px; margin-bottom: 20px; }
            .options-container { gap: 10px; }
            .option-btn { padding: 12px 14px; font-size: 15px; }
            .answer-input { min-height: 120px; padding: 12px; font-size: 14px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>å¤šåŠŸèƒ½æ™ºèƒ½åˆ·é¢˜ç³»ç»Ÿ</h1>
            <div class="header-controls">
                <button id="themeToggleBtn" class="theme-btn">åˆ‡æ¢æ·±è‰²æ¨¡å¼</button>
            </div>
        </header>

        <!-- ä¸Šä¼ é¢˜åº“é¡µé¢ -->
        <div id="uploadPage" class="page active">
            <div class="upload-page">
                <div class="upload-card">
                    <h2 class="upload-title">ä¸Šä¼ é¢˜åº“å¼€å§‹åˆ·é¢˜</h2>
                    <p class="upload-desc">
                        æ”¯æŒè‡ªåŠ¨è¯†åˆ«é€‰æ‹©é¢˜å’Œç®€ç­”é¢˜æ ¼å¼<br>
                        é€‰æ‹©é¢˜æ ¼å¼ï¼šé¢˜å¹²|é€‰é¡¹1|é€‰é¡¹2|é€‰é¡¹3|ç­”æ¡ˆ|è§£æ<br>
                        ç®€ç­”é¢˜æ ¼å¼ï¼šQ:é¢˜å¹²å†…å®¹ï¼ˆæ¢è¡Œï¼‰A:ç­”æ¡ˆå†…å®¹<br>
                        æ”¯æŒæ‰¹é‡ä¸Šä¼ å¤šä¸ªé¢˜åº“æ–‡ä»¶
                    </p>
                    
                    <input type="file" id="fileInput" accept=".txt" multiple style="display: none;">
                    <button class="btn upload-btn primary-btn" onclick="document.getElementById('fileInput').click()">ä¸Šä¼ é¢˜åº“æ–‡ä»¶ï¼ˆTXTæ ¼å¼ï¼‰</button>
                    
                    <div id="quizList" class="quiz-list">
                        <div style="padding: 20px; text-align: center; color: #64748b;">æš‚æ— ä¸Šä¼ çš„é¢˜åº“ï¼Œè¯·å…ˆä¸Šä¼ æ–‡ä»¶</div>
                    </div>
                    
                    <button id="startQuizBtn" class="start-quiz-btn" disabled>å¼€å§‹åˆ·é¢˜</button>
                </div>
            </div>
        </div>

        <!-- ç­”é¢˜é¡µé¢ -->
        <div id="quizPage" class="page">
            <button class="back-btn" onclick="goBackToUpload()">è¿”å›é¢˜åº“é€‰æ‹©</button>
            
            <div class="timer" id="timer">00:00:00</div>
            <div class="question-info">
                <span id="questionNum">é¢˜ç›® #1</span>
                <span id="totalQuestions">/ 0</span>
            </div>
            <div class="question-type-tag" id="questionTypeTag">é¢˜å‹</div>
            <div id="questionContentWrapper">
                <div class="question-content" id="questionText">åŠ è½½ä¸­...</div>
            </div>
            <div class="options-container" id="optionsContainer"></div>
            <div class="essay-answer-container" id="essayAnswerContainer">
                <textarea class="answer-input" id="essayAnswerInput" placeholder="åœ¨è¿™é‡Œè¾“å…¥ä½ çš„ç­”æ¡ˆ..."></textarea>
                <div class="answer-ref-container" id="answerRefContainer">
                    <div class="answer-ref-title">å‚è€ƒç­”æ¡ˆ</div>
                    <div class="answer-ref-content" id="answerRefContent"></div>
                </div>
            </div>
            <div class="submit-btn-area" id="submitBtnArea">
                <button class="submit-btn" id="submitAnswerBtn">æäº¤ç­”æ¡ˆ</button>
            </div>
            <div class="analysis-btn-area">
                <button class="analysis-btn" id="showAnalysisBtn" onclick="toggleAnswerAnalysis()" disabled>æŸ¥çœ‹è§£æ/ç­”æ¡ˆ</button>
            </div>
            <div class="analysis-container" id="analysisContainer"></div>
            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn" onclick="goToPrevQuestion()" disabled>ä¸Šä¸€é¢˜</button>
                <button class="nav-btn" id="nextBtn" onclick="goToNextQuestion()" disabled>ä¸‹ä¸€é¢˜</button>
            </div>
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
                <div class="progress-thumb" id="progressThumb"></div>
                <div class="progress-text" id="progressText">0/0</div>
            </div>
            <div class="stats-area">
                <div class="stat-item">æ­£ç¡®ï¼š<span id="correctCount">0</span></div>
                <div class="stat-item">é”™è¯¯ï¼š<span id="incorrectCount">0</span></div>
                <div class="stat-item">å·²ç­”ï¼š<span id="attemptedCount">0</span></div>
                <div class="stat-item">å®Œæˆï¼š<span id="essayCompletedCount">0</span></div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // å¸¸é‡å®šä¹‰
        const CONST = {
            STORAGE: 'quizAppData_v5',
            TOAST_TIME: 2000,
            TIMER_INTERVAL: 1000,
            FILE_TYPES: ['.txt'],
            ANSWER_OPTIONS: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'],
            AUTO_NEXT: 1000
        };

        // DOMç¼“å­˜
        const DOM = {
            // é€šç”¨
            themeToggleBtn: null, toast: null,
            
            // ä¸Šä¼ é¡µé¢
            uploadPage: null, fileInput: null, quizList: null, startQuizBtn: null,
            
            // ç­”é¢˜é¡µé¢
            quizPage: null, timer: null, questionNum: null, totalQuestions: null,
            questionTypeTag: null, questionText: null, questionContentWrapper: null,
            optionsContainer: null, essayAnswerContainer: null, essayAnswerInput: null,
            answerRefContainer: null, answerRefContent: null, submitBtnArea: null,
            submitAnswerBtn: null, showAnalysisBtn: null, analysisContainer: null,
            prevBtn: null, nextBtn: null, progressBar: null, progressThumb: null,
            progressContainer: null, progressText: null, correctCount: null,
            incorrectCount: null, attemptedCount: null, essayCompletedCount: null
        };

        // åº”ç”¨çŠ¶æ€
        const state = {
            quizList: [],          // æ‰€æœ‰ä¸Šä¼ çš„é¢˜åº“
            currentQuizId: '',     // å½“å‰é€‰ä¸­çš„é¢˜åº“ID
            currentIndex: 0,       // å½“å‰é¢˜ç›®ç´¢å¼•
            answers: {},           // ç”¨æˆ·ç­”æ¡ˆè®°å½•
            stats: {               // ç»Ÿè®¡æ•°æ®
                correct: 0, 
                incorrect: 0, 
                totalAttempted: 0, 
                essayCompleted: 0 
            },
            settings: { theme: 'light' },  // è®¾ç½®
            timerId: null,         // è®¡æ—¶å™¨ID
            elapsedTime: 0,        // å·²ç”¨æ—¶é—´
            selectedOptions: [],   // å½“å‰é€‰ä¸­çš„é€‰é¡¹
            isAnswered: false,     // æ˜¯å¦å·²ç­”é¢˜
            isAnalysisShown: false,// æ˜¯å¦æ˜¾ç¤ºè§£æ
            isAnswerShown: false,  // æ˜¯å¦æ˜¾ç¤ºç­”æ¡ˆ
            isDragging: false      // æ˜¯å¦æ‹–åŠ¨è¿›åº¦æ¡
        };

        // åˆå§‹åŒ–
        function init() {
            // ç¼“å­˜DOMå…ƒç´ 
            Object.keys(DOM).forEach(key => {
                DOM[key] = document.getElementById(key);
            });

            // ç»‘å®šäº‹ä»¶
            DOM.fileInput.addEventListener('change', handleFileUpload);
            DOM.startQuizBtn.addEventListener('click', startQuiz);
            DOM.themeToggleBtn.addEventListener('click', toggleTheme);
            DOM.optionsContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('.option-btn');
                btn && !state.isAnswered && selectAnswer(btn.dataset.option);
            });
            DOM.submitAnswerBtn.addEventListener('click', validateAnswer);
            DOM.essayAnswerInput.addEventListener('input', () => {
                const q = getCurrentQuestion();
                if (q && q.type === 'essay') {
                    DOM.nextBtn.disabled = false;
                    state.answers[q.id] = state.answers[q.id] || {};
                    state.answers[q.id].input = DOM.essayAnswerInput.value;
                }
            });

            // è¿›åº¦æ¡äº‹ä»¶
            DOM.progressContainer.addEventListener('mousedown', (e) => {
                state.isDragging = true;
                handleProgress(e);
            });
            document.addEventListener('mousemove', (e) => state.isDragging && handleProgress(e));
            document.addEventListener('mouseup', () => state.isDragging = false);
            DOM.progressContainer.addEventListener('click', (e) => !state.isDragging && handleProgress(e));
            DOM.progressContainer.addEventListener('touchstart', (e) => {
                state.isDragging = true;
                handleProgress(e, true);
            });
            document.addEventListener('touchmove', (e) => state.isDragging && handleProgress(e, true));
            document.addEventListener('touchend', () => state.isDragging = false);

            // åŠ è½½å­˜å‚¨æ•°æ®
            loadStorage();
            
            // åˆå§‹åŒ–ä¸»é¢˜
            state.settings.theme === 'dark' && document.body.classList.add('dark-mode');
            
            // æ›´æ–°é¢˜åº“åˆ—è¡¨
            updateQuizListDisplay();
            
            showToast('ç³»ç»Ÿå·²å°±ç»ªï¼', 'info');
        }

        // è¿›åº¦æ¡å¤„ç†
        function handleProgress(e, isTouch = false) {
            const quiz = getCurrentQuiz();
            if (!quiz || !quiz.questions.length) return;
            
            const rect = DOM.progressContainer.getBoundingClientRect();
            const x = isTouch ? e.touches[0].clientX : e.clientX;
            const percent = Math.max(0, Math.min(1, (x - rect.left) / rect.width));
            const index = Math.floor(percent * (quiz.questions.length - 1));
            
            if (index !== state.currentIndex) {
                state.currentIndex = index;
                updateQuestionDisplay();
                updateProgress();
            }
        }

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        function handleFileUpload(e) {
            const files = e.target.files;
            if (!files.length) return;
            
            Array.from(files).forEach(file => {
                const ext = file.name.slice(file.name.lastIndexOf('.')).toLowerCase();
                if (!CONST.FILE_TYPES.includes(ext)) {
                    showToast(`è·³è¿‡éTXTæ–‡ä»¶ï¼š${file.name}`, 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        // è‡ªåŠ¨è¯†åˆ«é¢˜ç›®ç±»å‹å¹¶è§£æ
                        const questions = parseQuestions(event.target.result, file.name);
                        if (questions.length) {
                            // ç»Ÿè®¡é¢˜å‹
                            const choiceCount = questions.filter(q => q.type !== 'essay').length;
                            const essayCount = questions.filter(q => q.type === 'essay').length;
                            
                            const id = `quiz_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
                            state.quizList.push({
                                id, 
                                name: file.name, 
                                questions,
                                choiceCount,
                                essayCount,
                                totalCount: questions.length,
                                uploadTime: new Date().toLocaleString()
                            });
                            
                            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªä¸Šä¼ çš„é¢˜åº“
                            if (state.quizList.length === 1) {
                                state.currentQuizId = id;
                            }
                            
                            showToast(`æˆåŠŸåŠ è½½é¢˜åº“ã€${file.name}ã€‘ï¼šå…±${questions.length}é¢˜ï¼ˆé€‰æ‹©é¢˜${choiceCount}é¢˜ï¼Œç®€ç­”é¢˜${essayCount}é¢˜ï¼‰`, 'success');
                            updateQuizListDisplay();
                        } else {
                            showToast(`é¢˜åº“ã€${file.name}ã€‘æ— æœ‰æ•ˆé¢˜ç›®`, 'error');
                        }
                        saveStorage();
                    } catch (err) {
                        console.error('è§£æå¤±è´¥:', err);
                        showToast(`è§£æé¢˜åº“ã€${file.name}ã€‘å¤±è´¥`, 'error');
                    }
                };
                reader.readAsText(file);
            });
            
            DOM.fileInput.value = '';
        }

        // è‡ªåŠ¨è¯†åˆ«å¹¶è§£æé¢˜ç›®
        function parseQuestions(text, fileName) {
            const lines = text.replace(/\r\n/g, '\n').split('\n').map(l => l.trim()).filter(l => l);
            const questions = [];
            let id = 1;
            
            // å…ˆå°è¯•è¯†åˆ«ç®€ç­”é¢˜
            let essayBuffer = { q: '', a: '' };
            lines.forEach(line => {
                // ç®€ç­”é¢˜æ ¼å¼ï¼šQ:å¼€å¤´
                if (line.startsWith('Q:')) {
                    // ä¿å­˜ä¸Šä¸€ä¸ªç®€ç­”é¢˜
                    if (essayBuffer.q && essayBuffer.a) {
                        questions.push({
                            id: id++, 
                            type: 'essay', 
                            typeText: 'ç®€ç­”é¢˜',
                            commonStem: '', 
                            question: essayBuffer.q.trim(), 
                            answer: essayBuffer.a.trim(), 
                            analysis: ''
                        });
                    }
                    essayBuffer.q = line.slice(2).trim();
                    essayBuffer.a = '';
                } 
                // ç®€ç­”é¢˜ç­”æ¡ˆï¼šA:å¼€å¤´
                else if (line.startsWith('A:') && essayBuffer.q) {
                    essayBuffer.a += line.slice(2).trim() + '\n';
                }
                // ç®€ç­”é¢˜å¤šè¡Œç­”æ¡ˆ
                else if (essayBuffer.q && essayBuffer.a) {
                    essayBuffer.a += line.trim() + '\n';
                }
                // é€‰æ‹©é¢˜æ ¼å¼ï¼ˆåŒ…å«|åˆ†éš”ç¬¦ï¼‰
                else if (line.includes('|')) {
                    // ä¿å­˜æœªå®Œæˆçš„ç®€ç­”é¢˜
                    if (essayBuffer.q && essayBuffer.a) {
                        questions.push({
                            id: id++, 
                            type: 'essay', 
                            typeText: 'ç®€ç­”é¢˜',
                            commonStem: '', 
                            question: essayBuffer.q.trim(), 
                            answer: essayBuffer.a.trim(), 
                            analysis: ''
                        });
                        essayBuffer = { q: '', a: '' };
                    }
                    
                    // è§£æé€‰æ‹©é¢˜
                    try {
                        const parts = line.split('|').map(p => p.trim()).filter(p => p);
                        let qObj = null;
                        
                        if (isSingleChoice(parts)) {
                            qObj = parseSingleChoice(parts, id, 'A');
                        } else if (isMultipleChoice(parts)) {
                            qObj = parseMultipleChoice(parts, id);
                        } else if (isComplexChoice(parts)) {
                            const res = parseComplexChoice(parts, id, parts[0].includes('ç»¼åˆ') ? 'Aç»¼åˆåˆ†æé€‰æ‹©é¢˜' : 'Bå‹é…ä¼é€‰æ‹©é¢˜');
                            questions.push(...res.questions);
                            id = res.nextId;
                            return;
                        }
                        
                        qObj && questions.push(qObj) && id++;
                    } catch (err) {
                        console.warn(`[${fileName}] ç¬¬${id}è¡Œè§£æå¤±è´¥:`, err, line);
                        id++;
                    }
                }
            });
            
            // ä¿å­˜æœ€åä¸€ä¸ªç®€ç­”é¢˜
            if (essayBuffer.q && essayBuffer.a) {
                questions.push({
                    id: id++, 
                    type: 'essay', 
                    typeText: 'ç®€ç­”é¢˜',
                    commonStem: '', 
                    question: essayBuffer.q.trim(), 
                    answer: essayBuffer.a.trim(), 
                    analysis: ''
                });
            }
            
            return questions;
        }

        // é€‰æ‹©é¢˜è§£æè¾…åŠ©å‡½æ•°
        function isSingleChoice(parts) {
            if (parts.length < 6 || parts.length > 11) return false;
            const count = parts.length - 3;
            if (count < 3 || count > 8) return false;
            return CONST.ANSWER_OPTIONS.includes(parts[parts.length - 2].toUpperCase());
        }

        function parseSingleChoice(parts, id, prefix = 'A') {
            const count = parts.length - 3;
            const options = parts.slice(1, 1 + count);
            const answer = parts[parts.length - 2].toUpperCase();
            const analysis = parts[parts.length - 1] || '';
            const optionMap = {};
            
            options.forEach((opt, i) => optionMap[CONST.ANSWER_OPTIONS[i]] = opt);
            
            return {
                id, type: 'single', typeText: `${prefix}æœ€ä½³é€‰æ‹©é¢˜`,
                commonStem: '', commonStemType: '', question: parts[0],
                options, optionMap, correctAnswers: [answer], analysis
            };
        }

        function isMultipleChoice(parts) {
            if (parts.length < 6 || parts.length > 11) return false;
            const count = parts.length - 3;
            if (count < 3 || count > 8) return false;
            const ans = parts[parts.length - 2].toUpperCase();
            return !CONST.ANSWER_OPTIONS.includes(ans) && /^[A-H, ]+$/.test(ans);
        }

        function parseMultipleChoice(parts, id) {
            const count = parts.length - 3;
            const options = parts.slice(1, 1 + count);
            let ansStr = parts[parts.length - 2].toUpperCase();
            const analysis = parts[parts.length - 1] || '';
            
            let answers = [];
            ansStr = ansStr.replace(/\s+/g, ',').replace(/,,+/g, ',');
            ansStr.split(',').filter(a => a).forEach(a => {
                a.length > 1 
                    ? answers = answers.concat(a.split('').filter(l => CONST.ANSWER_OPTIONS.includes(l)))
                    : answers.push(a);
            });
            
            answers = [...new Set(answers)]
                      .filter(a => CONST.ANSWER_OPTIONS.includes(a))
                      .sort();
            
            const optionMap = {};
            options.forEach((opt, i) => optionMap[CONST.ANSWER_OPTIONS[i]] = opt);
            
            return {
                id, type: 'multiple', typeText: 'Xå‹å¤šé€‰é¢˜',
                commonStem: '', commonStemType: '', question: parts[0],
                options, optionMap, correctAnswers: answers, analysis
            };
        }

        function isComplexChoice(parts) {
            if (parts.length < 7) return false;
            for (let i = 3; i <= 8; i++) {
                const unit = i + 2;
                const len = parts.length - 2;
                if (len > 0 && len % unit === 0) return true;
            }
            return false;
        }

        function parseComplexChoice(parts, startId, typeText) {
            const questions = [];
            const stem = parts[0];
            let pos = 1, id = startId, optCount = 0;
            
            for (let i = 3; i <= 8; i++) {
                const unit = i + 2;
                const len = parts.length - 2;
                if (len % unit === 0) {
                    optCount = i;
                    break;
                }
            }
            
            if (!optCount) throw new Error('æ— æ³•è¯†åˆ«é€‰é¡¹æ•°é‡');
            
            const unit = optCount + 2;
            const count = (parts.length - 2) / unit;
            
            for (let i = 0; i < count; i++) {
                const qIdx = pos;
                const optStart = pos + 1;
                const optEnd = optStart + optCount;
                const ansIdx = optEnd;
                
                const qText = parts[qIdx];
                const options = parts.slice(optStart, optEnd);
                const answer = parts[ansIdx].toUpperCase();
                const optionMap = {};
                
                options.forEach((opt, i) => optionMap[CONST.ANSWER_OPTIONS[i]] = opt);
                
                questions.push({
                    id: id++, type: 'single', typeText,
                    commonStem: stem, commonStemType: '',
                    question: qText, options, optionMap,
                    correctAnswers: [answer], analysis: parts[parts.length - 1] || ''
                });
                
                pos = ansIdx + 1;
            }
            
            return { questions, nextId: id };
        }

        // æ›´æ–°é¢˜åº“åˆ—è¡¨æ˜¾ç¤º
        function updateQuizListDisplay() {
            if (state.quizList.length === 0) {
                DOM.quizList.innerHTML = '<div style="padding: 20px; text-align: center; color: #64748b;">æš‚æ— ä¸Šä¼ çš„é¢˜åº“ï¼Œè¯·å…ˆä¸Šä¼ æ–‡ä»¶</div>';
                DOM.startQuizBtn.disabled = true;
                return;
            }
            
            DOM.quizList.innerHTML = '';
            state.quizList.forEach(quiz => {
                const item = document.createElement('div');
                item.className = `quiz-item ${quiz.id === state.currentQuizId ? 'active' : ''}`;
                item.innerHTML = `
                    <div class="quiz-info">
                        <div class="quiz-name">${quiz.name}</div>
                        <div class="quiz-meta">
                            ä¸Šä¼ æ—¶é—´ï¼š${quiz.uploadTime} | 
                            æ€»é¢˜æ•°ï¼š${quiz.totalCount} | 
                            é€‰æ‹©é¢˜ï¼š${quiz.choiceCount} | 
                            ç®€ç­”é¢˜ï¼š${quiz.essayCount}
                        </div>
                    </div>
                    <div class="quiz-actions">
                        <button class="select-quiz-btn" onclick="selectQuiz('${quiz.id}')">
                            ${quiz.id === state.currentQuizId ? 'å·²é€‰ä¸­' : 'é€‰æ‹©'}
                        </button>
                        <button class="delete-quiz-btn" onclick="deleteQuiz('${quiz.id}')">Ã—</button>
                    </div>
                `;
                DOM.quizList.appendChild(item);
            });
            
            // åªæœ‰é€‰ä¸­äº†é¢˜åº“æ‰èƒ½å¼€å§‹åˆ·é¢˜
            DOM.startQuizBtn.disabled = !state.currentQuizId;
        }

        // é€‰æ‹©é¢˜åº“
        function selectQuiz(id) {
            state.currentQuizId = id;
            updateQuizListDisplay();
            showToast(`å·²é€‰ä¸­é¢˜åº“ï¼š${state.quizList.find(q => q.id === id)?.name}`, 'info');
        }

        // åˆ é™¤é¢˜åº“
        function deleteQuiz(id) {
            const idx = state.quizList.findIndex(q => q.id === id);
            if (idx === -1) return;
            
            const quiz = state.quizList[idx];
            state.quizList.splice(idx, 1);
            
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„é¢˜åº“
            if (id === state.currentQuizId) {
                state.currentQuizId = state.quizList.length > 0 ? state.quizList[0].id : '';
            }
            
            updateQuizListDisplay();
            saveStorage();
            showToast(`å·²åˆ é™¤é¢˜åº“ï¼š${quiz.name}`, 'info');
        }

        // å¼€å§‹åˆ·é¢˜ï¼ˆåˆ‡æ¢åˆ°ç­”é¢˜é¡µé¢ï¼‰
        function startQuiz() {
            const quiz = getCurrentQuiz();
            if (!quiz || !quiz.questions.length) {
                showToast('è¯·å…ˆé€‰æ‹©æœ‰æ•ˆçš„é¢˜åº“ï¼', 'error');
                return;
            }
            
            // é‡ç½®çŠ¶æ€
            state.currentIndex = 0;
            state.elapsedTime = 0;
            state.selectedOptions = [];
            state.isAnswered = false;
            state.isAnalysisShown = false;
            state.isAnswerShown = false;
            
            // åˆ‡æ¢é¡µé¢
            DOM.uploadPage.classList.remove('active');
            DOM.quizPage.classList.add('active');
            
            // åˆå§‹åŒ–ç­”é¢˜ç•Œé¢
            updateQuestionDisplay();
            updateNavButtons();
            updateStats();
            updateProgress();
            startTimer();
            
            DOM.analysisContainer.style.display = 'none';
            DOM.answerRefContainer.style.display = 'none';
            
            showToast(`å¼€å§‹åˆ·é¢˜ï¼å…±${quiz.questions.length}é¢˜`, 'success');
        }

        // è¿”å›ä¸Šä¼ é¡µé¢
        function goBackToUpload() {
            // åœæ­¢è®¡æ—¶å™¨
            if (state.timerId) {
                clearInterval(state.timerId);
                state.timerId = null;
            }
            
            // åˆ‡æ¢é¡µé¢
            DOM.quizPage.classList.remove('active');
            DOM.uploadPage.classList.add('active');
            
            showToast('å·²è¿”å›é¢˜åº“é€‰æ‹©é¡µé¢', 'info');
        }

        // æ›´æ–°é¢˜ç›®æ˜¾ç¤º
        function updateQuestionDisplay() {
            const q = getCurrentQuestion();
            if (!q) return;
            
            const quiz = getCurrentQuiz();
            
            // æ›´æ–°åŸºç¡€ä¿¡æ¯
            DOM.questionNum.textContent = `é¢˜ç›® #${q.id}`;
            DOM.totalQuestions.textContent = `/ ${quiz.questions.length}`;
            DOM.questionTypeTag.textContent = q.typeText;
            
            // æ˜¾ç¤ºé¢˜å¹²
            if (q.commonStem) {
                DOM.questionContentWrapper.innerHTML = `
                    <div class="common-stem-wrapper">${q.commonStem}</div>
                    <div class="question-content" id="questionText">${q.question}</div>
                `;
                DOM.questionText = document.getElementById('questionText');
            } else {
                DOM.questionContentWrapper.innerHTML = `
                    <div class="question-content" id="questionText">${q.question}</div>
                `;
                DOM.questionText = document.getElementById('questionText');
            }
            
            // é¢˜å‹åˆ‡æ¢
            if (q.type === 'essay') {
                DOM.essayAnswerContainer.style.display = 'block';
                DOM.optionsContainer.style.display = 'none';
                DOM.submitBtnArea.style.display = 'none';
                
                // ç®€ç­”é¢˜æŒ‰é’®è®¾ç½®
                DOM.showAnalysisBtn.disabled = false;
                DOM.showAnalysisBtn.textContent = state.isAnswerShown ? 'ğŸ™ˆ éšè—å‚è€ƒç­”æ¡ˆ' : 'ğŸ‘ï¸ æ˜¾ç¤ºå‚è€ƒç­”æ¡ˆ';
                
                DOM.essayAnswerInput.value = state.answers[q.id]?.input || '';
                DOM.nextBtn.disabled = !state.answers[q.id]?.input;
                
                // æ¢å¤ä¹‹å‰çš„ç­”æ¡ˆæ˜¾ç¤ºçŠ¶æ€
                if (state.answers[q.id]?.isCompleted || state.isAnswerShown) {
                    DOM.answerRefContent.textContent = q.answer;
                    DOM.answerRefContainer.style.display = 'flex';
                    state.isAnswerShown = true;
                } else {
                    DOM.answerRefContainer.style.display = 'none';
                    state.isAnswerShown = false;
                }
            } else {
                DOM.essayAnswerContainer.style.display = 'none';
                DOM.optionsContainer.style.display = 'flex';
                
                // é€‰æ‹©é¢˜æŒ‰é’®è®¾ç½®
                if (q.analysis) {
                    DOM.showAnalysisBtn.disabled = false;
                    DOM.showAnalysisBtn.textContent = state.isAnalysisShown ? 'éšè—è§£æ' : 'æŸ¥çœ‹è§£æ';
                } else {
                    DOM.showAnalysisBtn.disabled = true;
                    DOM.showAnalysisBtn.textContent = 'æš‚æ— è§£æ';
                }
                
                DOM.submitBtnArea.style.display = q.type === 'multiple' ? 'block' : 'none';
                
                state.isAnswered = false;
                state.isAnalysisShown = false;
                state.selectedOptions = state.answers[q.id]?.selected || [];
                renderOptions();
                DOM.analysisContainer.style.display = 'none';
            }
            
            updateProgress();
            updateNavButtons();
        }

        // æ¸²æŸ“é€‰é¡¹
        function renderOptions() {
            DOM.optionsContainer.innerHTML = '';
            const q = getCurrentQuestion();
            if (!q || q.type === 'essay') return;
            
            q.options.forEach((opt, i) => {
                if (!opt) return;
                
                const key = CONST.ANSWER_OPTIONS[i];
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.dataset.option = key;
                btn.innerHTML = `
                    <span class="option-letter">${key}</span>
                    <span class="option-text">${opt}</span>
                `;
                
                if (state.selectedOptions.includes(key)) btn.classList.add('selected');
                
                if (state.answers[q.id]?.isAnswered) {
                    btn.disabled = true;
                    if (q.correctAnswers.includes(key)) {
                        btn.classList.add('correct');
                    } else if (state.selectedOptions.includes(key)) {
                        btn.classList.add('incorrect');
                    }
                }
                
                DOM.optionsContainer.appendChild(btn);
            });
        }

        // é€‰æ‹©ç­”æ¡ˆ
        function selectAnswer(opt) {
            const q = getCurrentQuestion();
            if (!q || q.type === 'essay') return;
            
            const btns = document.querySelectorAll('.option-btn');
            
            if (q.type === 'single') {
                btns.forEach(b => b.classList.remove('selected'));
                state.selectedOptions = [opt];
                validateAnswer(); // å•é€‰é¢˜è‡ªåŠ¨æäº¤
            } else {
                const idx = state.selectedOptions.indexOf(opt);
                if (idx > -1) {
                    state.selectedOptions.splice(idx, 1);
                    btns.forEach(b => b.dataset.option === opt && b.classList.remove('selected'));
                } else {
                    state.selectedOptions.push(opt);
                    btns.forEach(b => b.dataset.option === opt && b.classList.add('selected'));
                }
            }
        }

        // éªŒè¯ç­”æ¡ˆ
        function validateAnswer() {
            const q = getCurrentQuestion();
            if (!q || q.type === 'essay') return;
            
            if (state.selectedOptions.length === 0) {
                showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé€‰é¡¹ï¼', 'error');
                return;
            }
            
            state.isAnswered = true;
            
            const userAns = [...state.selectedOptions].sort();
            const correctAns = [...q.correctAnswers].sort();
            const isCorrect = JSON.stringify(userAns) === JSON.stringify(correctAns);
            
            // æ›´æ–°ç»Ÿè®¡
            const prev = state.answers[q.id];
            if (prev) {
                prev.isCorrect ? state.stats.correct-- : state.stats.incorrect--;
            }
            
            if (isCorrect) {
                state.stats.correct++;
                showToast('å›ç­”æ­£ç¡®ï¼', 'success');
                setTimeout(() => {
                    state.currentIndex < getCurrentQuiz().questions.length - 1 && goToNextQuestion();
                }, CONST.AUTO_NEXT);
            } else {
                state.stats.incorrect++;
                showToast('å›ç­”é”™è¯¯ï¼', 'error');
                // æ˜¾ç¤ºè§£æ
                if (q.analysis) {
                    state.isAnalysisShown = true;
                    DOM.analysisContainer.style.display = 'block';
                    DOM.analysisContainer.textContent = q.analysis;
                    DOM.showAnalysisBtn.textContent = 'éšè—è§£æ';
                }
            }
            
            state.stats.totalAttempted = Object.keys(state.answers).length;
            !prev && state.stats.totalAttempted++;
            
            state.answers[q.id] = {
                selected: state.selectedOptions,
                isCorrect,
                isAnswered: true
            };
            
            // æ ‡è®°ç­”æ¡ˆç»“æœ
            document.querySelectorAll('.option-btn').forEach(btn => {
                const opt = btn.dataset.option;
                btn.disabled = true;
                
                if (q.correctAnswers.includes(opt)) {
                    btn.classList.add('correct');
                } else if (state.selectedOptions.includes(opt) && !isCorrect) {
                    btn.classList.add('incorrect');
                }
            });
            
            q.type === 'multiple' && (DOM.submitBtnArea.style.display = 'none');
            
            updateStats();
            saveStorage();
        }

        // åˆå¹¶çš„ç­”æ¡ˆ/è§£æåˆ‡æ¢å‡½æ•°
        function toggleAnswerAnalysis() {
            const q = getCurrentQuestion();
            if (!q) return;
            
            // ç®€ç­”é¢˜é€»è¾‘
            if (q.type === 'essay') {
                state.isAnswerShown = !state.isAnswerShown;
                
                if (state.isAnswerShown) {
                    DOM.answerRefContent.textContent = q.answer;
                    DOM.answerRefContainer.style.display = 'flex';
                    DOM.showAnalysisBtn.textContent = 'ğŸ™ˆ éšè—å‚è€ƒç­”æ¡ˆ';
                    
                    // æ›´æ–°ç»Ÿè®¡
                    state.answers[q.id] = state.answers[q.id] || {};
                    if (!state.answers[q.id].isCompleted) {
                        state.answers[q.id].isCompleted = true;
                        state.stats.essayCompleted++;
                        updateStats();
                        saveStorage();
                    }
                } else {
                    DOM.answerRefContainer.style.display = 'none';
                    DOM.showAnalysisBtn.textContent = 'ğŸ‘ï¸ æ˜¾ç¤ºå‚è€ƒç­”æ¡ˆ';
                }
            } 
            // é€‰æ‹©é¢˜é€»è¾‘
            else {
                state.isAnalysisShown = !state.isAnalysisShown;
                DOM.analysisContainer.style.display = state.isAnalysisShown ? 'block' : 'none';
                DOM.showAnalysisBtn.textContent = state.isAnalysisShown ? 'éšè—è§£æ' : 'æŸ¥çœ‹è§£æ';
                
                if (q) DOM.analysisContainer.textContent = q.analysis || 'æš‚æ— è§£æ';
            }
        }

        // ä¸Šä¸€é¢˜
        function goToPrevQuestion() {
            if (state.currentIndex > 0) {
                state.currentIndex--;
                updateQuestionDisplay();
            }
        }

        // ä¸‹ä¸€é¢˜
        function goToNextQuestion() {
            const quiz = getCurrentQuiz();
            if (!quiz) return;
            
            // ä¿å­˜ç®€ç­”é¢˜ç­”æ¡ˆ
            const q = getCurrentQuestion();
            if (q && q.type === 'essay') {
                state.answers[q.id] = state.answers[q.id] || {};
                state.answers[q.id].input = DOM.essayAnswerInput.value;
                
                if (DOM.answerRefContainer.style.display === 'flex' && !state.answers[q.id].isCompleted) {
                    state.answers[q.id].isCompleted = true;
                    state.stats.essayCompleted++;
                }
                
                if (!state.answers[q.id].isRecorded) {
                    state.answers[q.id].isRecorded = true;
                    state.stats.totalAttempted++;
                }
                
                updateStats();
                saveStorage();
            }
            
            if (state.currentIndex < quiz.questions.length - 1) {
                state.currentIndex++;
                updateQuestionDisplay();
            } else {
                showToast('å·²å®Œæˆæ‰€æœ‰é¢˜ç›®ï¼', 'info');
            }
        }

        // è¾…åŠ©å‡½æ•°
        function getCurrentQuiz() {
            return state.quizList.find(q => q.id === state.currentQuizId) || null;
        }

        function getCurrentQuestion() {
            const quiz = getCurrentQuiz();
            return quiz ? quiz.questions[state.currentIndex] || null : null;
        }

        function updateNavButtons() {
            const quiz = getCurrentQuiz();
            if (!quiz) return;
            
            DOM.prevBtn.disabled = state.currentIndex === 0;
            DOM.nextBtn.disabled = state.currentIndex >= quiz.questions.length - 1;
        }

        function updateProgress() {
            const quiz = getCurrentQuiz();
            if (!quiz) return;
            
            const progress = ((state.currentIndex + 1) / quiz.questions.length) * 100;
            DOM.progressBar.style.width = `${progress}%`;
            DOM.progressThumb.style.left = `${progress}%`;
            DOM.progressText.textContent = `${state.currentIndex + 1}/${quiz.questions.length}`;
        }

        function updateStats() {
            DOM.correctCount.textContent = state.stats.correct;
            DOM.incorrectCount.textContent = state.stats.incorrect;
            DOM.attemptedCount.textContent = state.stats.totalAttempted;
            DOM.essayCompletedCount.textContent = state.stats.essayCompleted;
        }

        function startTimer() {
            state.timerId && clearInterval(state.timerId);
            updateTimer();
            state.timerId = setInterval(updateTimer, CONST.TIMER_INTERVAL);
        }

        function updateTimer() {
            state.elapsedTime++;
            const hours = Math.floor(state.elapsedTime / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((state.elapsedTime % 3600) / 60).toString().padStart(2, '0');
            const seconds = (state.elapsedTime % 60).toString().padStart(2, '0');
            DOM.timer.textContent = `${hours}:${minutes}:${seconds}`;
        }

        function toggleTheme() {
            state.settings.theme = state.settings.theme === 'light' ? 'dark' : 'light';
            document.body.classList.toggle('dark-mode');
            saveStorage();
        }

        function showToast(message, type = 'info') {
            DOM.toast.textContent = message;
            DOM.toast.className = `toast ${type}`;
            DOM.toast.style.opacity = '1';
            
            setTimeout(() => {
                DOM.toast.style.opacity = '0';
            }, CONST.TOAST_TIME);
        }

        function loadStorage() {
            try {
                const data = localStorage.getItem(CONST.STORAGE);
                if (data) {
                    const parsed = JSON.parse(data);
                    Object.assign(state, parsed);
                }
            } catch (err) {
                console.error('åŠ è½½å­˜å‚¨å¤±è´¥:', err);
            }
        }

        function saveStorage() {
            try {
                localStorage.setItem(CONST.STORAGE, JSON.stringify(state));
            } catch (err) {
                console.error('ä¿å­˜å­˜å‚¨å¤±è´¥:', err);
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        window.addEventListener('load', init);
    </script>
</body>
</html>
